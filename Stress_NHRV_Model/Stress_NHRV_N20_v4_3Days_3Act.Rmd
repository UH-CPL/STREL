---
title: "Stress Model NHRV (3 digits) | N = 20 | 5 min | Thresh = mean \n | Manual Intervention of Activity Classification"
author: "Field Lab |  ACDC Lab"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: united
    number_sections: true 
  pdf_document: 
    toc: true
header-includes:
   - \usepackage{amsmath}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, #prevents code, but not the results from appearing in the finished file
	message = FALSE, #prevents messages that are generated by code from appearing in the finished file
	warning = FALSE #prevents warnings that are generated by code from appearing in the finished file
)
```


----------

**Step 1: Generate  Stress/No-Stress Labels:** We replace the NHRV response variable with the binary variable Stress/No-Stress. For that, we generate Stress/No-Stress labels for each 5 min interval based on the NHRV values and the psycho-physiological definition of stress as instantaneous hyperarousal. If normalized NHRV does not exhibit severe deviations from normality, then anything to the right of mean could be considered hyperarousal (and thus Stress). The remaining of the distribution could be considered as No-Stress.


**Step 2: Regress on Stress/No-Stress:** Using the Stress/No-Stress binary variable as the response variable, we run a model that provides explanations for the sources of participant stress.


----------

\newpage

```{r libraries, include=FALSE}
library(tidyverse) # includes ggplot2 dplyr tidyr readr purrr tibble stringr forcats
library(latex2exp) # parses and converts LaTeX math formulas to R's plotmath expressions
library(ggpubr) # facilitates the creation of beautiful ggplot2-based graphs
library(arm)  # convenience functions for regression in R
library(jtools) # efficient presentation of regression analysis, e.g., summ() function
library(ggcorrplot) # visualize easily a correlation matrix using ggplot2
require(ggpmisc) # extension to ggplot2
library(cowplot) # extension to ggplot - arranging plots in a grid
library(hms) # pretty time of day

theme_set(theme_classic()) # set the theme to classic
theme_update(plot.title = element_text(hjust = 0.5)) # center the title

rm(list = ls())
dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(dir)
getwd()
```


```{r themes}
# Without x axis label first rows
my_theme <- theme_bw() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 10, face = "bold"),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )

# With  x-y axis label
my_theme1 <- my_theme +
  theme(
    axis.text.x = element_text(size = 8, face = "bold")
  )

mycolors_stress = c(NS = "green", S ="red")

n_fun <- function(x) {
  return(data.frame(y = median(x) * 1.3, label = paste0("~italic(n)", " == ", length(x))))
}

activity_names <- c(
  `sleeping` = "Sleeping",
  `office_home` = "Office Work",
  `walking` = "Walking",
  `running` = "Running",
  `biking` = "Biking",
  `driving` = "Driving"
)

my_theme3 =   theme_bw() +theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(size = 10, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    legend.position = "none"
  )

options(digits=4)

data_dir = "../data/"

plot_dir = "../Figures/"
```

```{r SignificanceLegend, echo=FALSE}
# Create the significance legend

levels <- c("A", "S1", "B", "C")
num <- c(5, 10, 15, 20)
ymin <- c(0, 0, 0, 0)
ymax <- c(1, 2, 3, 4)

Legend_DF <- data.frame(levels, num, ymin, ymax)

plot <- ggplot(Legend_DF, aes(x = levels, y = num, colour = levels)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), size = 1.1) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(face = "bold", size = 10),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    legend.key.width = unit(1.7, "cm"),
    legend.text = element_text(size = 20)
  ) +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  scale_color_manual(
    values = c("black", "cyan", "#ee9a00", "red"),
    breaks = c("A", "S1", "B", "C"),
    labels = c("NS     ", "*     ", "**     ", "***")
  )

mylegend <- ggpubr::get_legend(plot)


```


```{r SignalDataReading, echo=FALSE}
# Read the data
#file = "../All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL.csv"
#file <- "../All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL_HRV.csv"

data_dir = "../data/"
file <- "All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL_Activity4.csv"

all.df2 = read.csv(paste0(data_dir, file), stringsAsFactors = T)

all.df2 <- all.df2 %>%
  filter(!is.na(Day_label)) %>%
  filter(!is.na(Time)) %>%
  mutate(Day_label = as.character(Day_label)) 

# #Remove T0017 DC1.3 is the sleep data of CD. Since the
# all.df2 <- all.df2 %>%
#   filter(!(ID == "T017" & subDC == "DC1.3")) 

# for ID = T017, if the Time has "3/29/24" then Day_label = "CD"
all.df2$Day_label <- ifelse(all.df2$ID == "T017" & all.df2$subDC == "DC1.3" & grepl("3/29/24", all.df2$Time), "CD", all.df2$Day_label)

all.df2$Gender <- NULL

```



```{r AddingSleepLabel, include=FALSE}

unique(all.df2$Activity4)

all.df2$Activity4 <- as.factor(all.df2$Activity4)

all.df2 <- all.df2 %>%
  mutate(Activity4 = recode(Activity4, 
                          "sleeping" = "Sleeping",
                          "Work" = "Work",
                          "NonWork" = "NonWork",
                          "walking" = "Walking",
                          "running" = "Running",
                          "biking" = "Biking",
                          "driving" = "Driving",
                          "unknown" = "Unknown",
                          ))


all.df2$Activity4 <- factor(all.df2$Activity4, 
                          levels = c("Work", "NonWork", "Walking", "Running", "Biking", "Driving", "Unknown", "Sleeping"))

```




```{r FormatTimeLevels, include=FALSE}

all.df2$Time <- strptime(all.df2$Time, format = "%Y-%m-%d %H:%M")
all.df2$Time <- format(all.df2$Time, format = "%Y-%m-%d %H:%M")
all.df2$Time <- as.POSIXct(all.df2$Time, format = "%Y-%m-%d %H:%M")

all.df2$Time2 <- format(all.df2$Time, "%H:%M:%S")
all.df2$Time2 <- as.POSIXct(all.df2$Time2, format = "%H:%M:%S")

all.df2$Date <- as.POSIXct(all.df2$Date, 
           format = "%Y-%m-%d")


all.df2 <- all.df2 %>% 
    filter(Day_label != "NA") %>%
    filter(!is.na(Time)) %>%
  droplevels()


all.df2$Day_label <- recode_factor(all.df2$Day_label,
                                  "PR" = "WD", "PR2" = "WD", "PR5" = "WD",
                                  "MD" = "CD", "MD2" = "CD", 
                                  "PS" = "WD", "PS2" = "WD", 
                                  "RD" = "OD", "RD2" = "OD", "RD3" = "OD"
)

# Day_label reference level is CD
all.df2$Day_label <- factor(all.df2$Day_label, levels = c("CD", "WD", "OD"))

all.df2$Sleep_label <- factor(all.df2$Sleep_label, levels = c("Not_Sleep", "Sleep"))
levels(all.df2$Sleep_label)


```

```{r SedentaryActivities}

all.df3_OD <- all.df2%>%
  filter(Activity4 %in% c("Work", "NonWork", "Driving")) %>%
  droplevels()

#table(all.df3_OD$ID, all.df3_OD$Day_label, all.df3_OD$Activity4)
```

```{r PsychDataReading, include=FALSE}

# Read the psychometric data and drop the unnecessary columns based on ID and Date.

fileName = "Exp_NASA_Sleep_N24.csv"
Psych_Data = read.csv(paste0(data_dir, fileName), stringsAsFactors = T)

# drop na in day_label and day_seq
Psych_DF <- Psych_Data %>%
  drop_na(Day_label, Day_seq) %>%
dplyr::select(ID, Date, Gender,S_duration_Qualtrics, Profession, NASA_sum, N_MD, N_PD, N_TD, N_P, N_E, N_F)

all.df21 = merge(all.df2, Psych_DF, 
                     by.x = c("ID","Date"), by.y = c("ID","Date"), all.x = T)

all.df21 %>% rename("Sleep_Time" = "S_duration_Qualtrics") -> all.df21

all.df21$Time2 <- format(all.df21$Time, "%H:%M:%S")
all.df21$Time2 <- as.POSIXct(all.df21$Time2, format = "%H:%M:%S")

colSums(is.na(all.df21))
all.df21 <- all.df21 %>% 
    filter(Day_label != "NA") %>%
    filter(Activity3 != "unknown") %>% droplevels()

all.df21$Activity = factor(all.df21$Activity, 
                              levels = c("office_home", "walking", "running", "biking", "driving"))

levels(all.df21$Activity)
unique(all.df21$Activity)

levels(all.df21$Activity3) 
unique(all.df21$Activity3)


colSums(is.na(all.df21))

# Assign proper names to the variables
all.df3 <- all.df21 %>%
  rename(
  Participant = ID,
  Day = Day_label,
  HR_Normalized = HR_normalized,
  Speed = Speed_NR,
  )

# Assign proper names to the levels of the Activity3 variable
all.df3 <- all.df3 %>%
  mutate(Activity3 = recode(Activity3, 
                          "office_home" = "Office.Home",
                          "walking" = "Walking",
                          "running" = "Running",
                          "biking" = "Biking",
                          "driving" = "Driving",
                          "unknown" = "Unknown",
                          ))

# Remove Unknown activity from consideration
all.df3 <- all.df3 %>% filter(Activity3 != "Unknown")
 
all.df3 <- all.df3 %>% drop_na(Day)


# Create  PA_Activity variable - nPA and PA
all.df3$PA_Activity <- NA # as.character(all.df2$max_ind)
all.df3[all.df3$Activity3 == "Office.Home",]$PA_Activity =  "Sedentary"
all.df3[all.df3$Activity3 == "Driving",]$PA_Activity =  "Sedentary"

all.df3[all.df3$Activity3 == "Walking",]$PA_Activity =  "PA"
all.df3[all.df3$Activity3 == "Running",]$PA_Activity =  "PA"
all.df3[all.df3$Activity3 == "Biking",]$PA_Activity =  "PA"


# Day reference level is CD
all.df3$Day <- relevel(all.df3$Day, ref = "CD")

# Create Normalized HRV
all.df3$NRR = round(all.df3$RR/all.df3$HR, 5)
```



## Non-Physical Acitvity (nPA) Table for Each Participant & Day
### Calculate PA_AVG_INT

```{r ActivityGroupingStressLabeling, echo=FALSE}
All_Summary <- all.df3 %>% 
  group_by(Participant, Day) %>%
  summarise(n = sum(Activity3 == "Office.Home",Activity3 == "Driving", Activity3 == "Running" | Activity3 == "Walking" | Activity3 == "Biking", na.rm = TRUE), 
            PA_Percent = sum(Activity3 == "Walking" | Activity3 == "Running" | Activity3 == "Biking", na.rm = TRUE) *100 / n
  )  %>%
  ungroup() %>%
  mutate(total_n = sum(n)) # add df len with

All_Summary = All_Summary %>% # remove the n_total column
  dplyr::select(-total_n) 

# Blue part
PA_Summary = all.df3 %>%
  group_by(Participant, Day) %>%
  filter(Activity3 %in% c("Walking", "Running", "Biking")) %>%
  summarise(
    PA_AVG_INT = round(mean(Cadence, na.rm=TRUE),1) # mean Cadence per day per subject
  ) 

All_Summary2 = merge(All_Summary, PA_Summary, by = c("Participant", "Day"), all.x = T) 

# white
all.df3_nPA = all.df3 %>%
  group_by(Participant, Day) %>%
  filter(Activity3 %in% c("Office.Home", "Driving")) %>%
  filter(!is.na(NRR)) %>%
  mutate(
   NHRV_Mean_nPA = round(mean(NRR,na.rm=TRUE),5),
   HRV_SD_nPA = round(sd(NRR,na.rm=TRUE),5),
  ) %>% droplevels()
  
# Use NHRV, Mean, and SD  for stress labeling
all.df3_OD = merge(all.df3_nPA, All_Summary2, by = c("Participant", "Day"), all.x = T)

all.df3_OD$PA_AVG_INT[is.na(all.df3_OD$PA_AVG_INT)] <- 0

all.df3_OD <- all.df3_OD %>%
  group_by(Participant, Day) %>%
  mutate(
    #Stress = ifelse(HR_Normalized > HR_Mean_nPA, "S", "NS"), # mean is the threshold
    Stress = ifelse(NRR < NHRV_Mean_nPA, "S", "NS"), # mean is the threshold
    # percent of "S" in Stress
    Stress_Percent = sum(Stress == "S", na.rm = TRUE) *100 / n()
  )

all.df3_OD$Stress <- as.factor(all.df3_OD$Stress)

```



## Participant and Day Table
```{r}
table(all.df3_OD$Participant, all.df3_OD$Day)
```



```{r eval=FALSE, include=FALSE}
# Save as csv file
#write.csv(all.df3_OD, "../Stress_model_data_OH_DR_N24.csv", row.names = F)
#write.csv(all.df3_OD, "../Stress_model_data_OH_DR_HRV_N24.csv", row.names = F)
#write.csv(all.df3_OD, "../Stress_model_data_OH_DR_NHRV_N24.csv", row.names = F)
names(all.df3_OD)

```


## Step 1 - Generate Stress/No-Stress Labels

## Distrubution of NHRV in Driving and Office.Home

```{r hr_normalized_pdf}

all.df3_OD %>%
  filter(Activity3 %in% c("Office.Home", "Driving")) %>%
  ggplot(aes(x = NRR, fill = Activity4)) +
  geom_density(alpha = 1) +
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = TeX(r'($\NRR \[ms\])'),
       y = "PDF")

```


## T025 - Stress Threshold Visualization, QQPlots, Table
```{r stress_threshold_viz_t001, echo=FALSE, fig.height=4, fig.width=4}

# Create a complete grid of Participant and Day combinations
complete_grid <- expand_grid(
  Participant = sprintf("T%03d", 1:25), 
  Day = c("CD", "WD", "OD")
)

complete_grid$Day = factor(complete_grid$Day, levels = c("CD", "WD", "OD"))

mult_format <- function() {
     function(x) format(100*x,digits = 2) 
}

# Ensure all combinations are present in the data
all_df3_complete <- complete_grid %>%
  left_join(all.df3_OD, by = c("Participant", "Day"))

# T025
plot_stress_distr <- all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 25) ) %>%
  ggplot(aes(x = NRR, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge") +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "none") +
  scale_x_continuous(breaks = c(0.005, 0.01), labels = mult_format()) +
  labs(x = TeX(r'(\textit{NHRV}  \[ms\])'), y = "Frequency") +
  geom_vline(aes(xintercept = NHRV_Mean_nPA), color = "blue", linetype = 3, linewidth = 1)


# Create qq plots for T025 of Day
plot_stress_qq <- all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 25) ) %>%
  ggplot(aes(sample = NRR)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  scale_y_continuous(#trans='probit', 
                     labels = mult_format()) +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3) +
  theme(legend.position = "none")


plot_stress_label <- cowplot::plot_grid(plot_stress_distr, plot_stress_qq, label_size = 8,
                   labels = c("b1","b2"), ncol = 1, nrow = 2)

plot_stress_label


plot_file = paste0(plot_dir, "HRV-Stress-Label-Plots.pdf")
ggsave(plot_file, plot_stress_label, width = 4.0, height = 4.0, dpi = 300)


library(psych) # describe()

all.df3_OD %>%
  ungroup() %>%
  filter(Participant %in% sprintf("T%03d", 1) ) %>%
  group_by(Day) %>%
  dplyr::select(Participant,Day, NRR, PA_Percent, PA_AVG_INT) %>%
  distinct() %>%
  ungroup() %>%
  psych::describe()

detach("package:psych", unload=TRUE)

```


## NHRV Histograms per Participant and Day

```{r stress_threshold_viz, echo=FALSE, fig.height=11, fig.width=11}
# T001, T002, T003, T004, T005, T006
all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(x = NRR, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge") +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "NHRV in Office.Home + Driving Activities, black line = 0+SD, blue line = Mean",
       x = TeX(r'($\NHRV \[ms\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = HRV_SD_nPA), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHRV_Mean_nPA), color = "blue", linetype = 3, linewidth = 1) 



all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(sample = NRR)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of NHRV in Office.Home + Driving Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")

```

```{r stress_threshold_viz2, echo=FALSE, fig.height=11, fig.width=11}
# T007, T008, T009, T010, T011, T012
all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(x = NRR, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge") +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "NHRV in Office.Home + Driving Activities, black line = 0+SD, blue line = Mean",
       x = TeX(r'($\NHRV \[ms\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = HRV_SD_nPA), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHRV_Mean_nPA), color = "blue", linetype = 3, linewidth = 1) 


all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(sample = NRR)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of NHRV in Office.Home + Driving Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")


```

```{r stress_threshold_viz3, echo=FALSE, fig.height=11, fig.width=11}
# T013, T014, T015, T016, T017, T018
all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(x = NRR, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge") +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "NHRV in Office.Home + Driving Activities, black line = 0+SD, blue line = Mean",
       x = TeX(r'($\NHRV \[ms\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = HRV_SD_nPA), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHRV_Mean_nPA), color = "blue", linetype = 3, linewidth = 1) 


all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(sample = NRR)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of NHRV in Office.Home + Driving Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")

```


```{r stress_threshold_viz4, echo=FALSE, fig.height=11, fig.width=11}
# T019, T020, T021, T022, T023, T024, T025
all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(x = NRR, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge") +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "NHRV in Office.Home + Driving Activities, black line = 0+SD, blue line = Mean",
       x = TeX(r'($\NHRV \[ms\])'), y = "Frequency") +
 # geom_vline(aes(xintercept = HRV_SD_nPA), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHRV_Mean_nPA), color = "blue", linetype = 3, linewidth = 1) 


all_df3_complete %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(sample = NRR)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of NHRV in Office.Home + Driving Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")

```


## Stress/No-Stress Counts per Participant

### PA_Percent Plot
```{r echo=FALSE}
plot_PA_Percent = all_df3_complete %>%
  group_by(Participant, Day) %>%
  dplyr::select(Participant,Day,PA_Percent) %>%
  distinct() %>%
ggplot(aes(x = Day, y = PA_Percent/100, fill = Day)) +
geom_boxplot() +
  my_theme1 +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "", y = "", title = "")+
  geom_text(label =  TeX(r'($\textit{PA_{pc}}$)'), x = 4, y= 0.3, color = "black", size = 5) +
    stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.1, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )
  
```

### PA_Percent and PA_AVG_INT Table

```{r echo=FALSE}

all_df3_complete %>%
  group_by(Participant, Day) %>%
  dplyr::select(Participant,Day,PA_Percent, PA_AVG_INT) %>%
  distinct() 

```


```{r stress_counts, fig.height=11, fig.width=9}

#table(all.df3_OD$Participant, all.df3_OD$PA_Percent)
#str(all.df3_OD)

tmp_P_list = sprintf("T%03d", 1:6)

all.df3_OD %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(n),
    prop = n / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  #geom_bar() +
  geom_bar(stat = "identity") +
  #add vline PA_Percent
  geom_hline(aes(yintercept = PA_Percent, linetype = "PA_Percent"), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  scale_linetype_manual(values = c("PA_Percent" = 2)) +
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%", title = "--- PA_Percent")
```

```{r stress_counts2, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 7:12)

all.df3_OD %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(n),
    prop = n / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  #geom_bar() +
  geom_bar(stat = "identity") +
  #add vline PA_Percent
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r stress_counts3, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 14:18)

all.df3_OD %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(n),
    prop = n / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  #geom_bar() +
  geom_bar(stat = "identity") +
  #add vline PA_Percent
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r stress_counts4, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 19:25)

all.df3_OD %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    # Filter participants and adjust factor levels to match the filtered dataset
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(n),
    prop = n / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  #geom_bar() +
  geom_bar(stat = "identity") +
  #add vline PA_Percent
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```

\newpage

# Step 2 - Regress on Stress/No-Stress

## Selected Participants 
```{r echo=FALSE}

Selected_P_IDs = sprintf("T%03d", 1:25)
# exclude T001, T002, T005, T009, T011, T019, T021
# exclude T001, T009, T011, T019
Selected_P_IDs = Selected_P_IDs[-c(1,9,11,19)]

#Selected_P_IDs

all.df3_OD <- all.df3_OD %>%
  filter(Participant %in% Selected_P_IDs) %>%
  droplevels()


table(all.df3_OD$Participant, all.df3_OD$Day)
```


## Big 5 Box Plots

```{r echo=FALSE, fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
# Read the sheet and drop the unnecessary columns based on ID and Date.
library("readxl")
library(psych)

#Experimenter_data_sheet2 <- read_excel(paste0("../", "ExperimenterNotes-FieldLAB.xlsx"), sheet = "Big-5")
Experimenter_data_sheet2 = read_csv(paste0(data_dir, "ExperimenterNotes-FieldLAB - Big-5.csv"))

#str(Experimenter_data_sheet2)
names(Experimenter_data_sheet2)[1] <- "ID"

Profession = Psych_Data %>% 
  filter(ID %in% Selected_P_IDs) %>%
  group_by(Profession) %>%
  dplyr::select(ID, Profession) %>%
  distinct() 
  
Experimenter_data_sheet2 = merge(Experimenter_data_sheet2, Profession, by = "ID")

big5_df = Experimenter_data_sheet2 %>%
  filter(ID %in% Selected_P_IDs) %>%
  droplevels() %>%
  drop_na(ID) %>%
  mutate(
    ID = as.character(ID),
    Agreeableness = as.numeric(Agreeableness),
    Conscientiousness = as.numeric(Conscientiousness),
    Extraversion = as.numeric(Extraversion),
    Neuroticism = as.numeric(Neuroticism),
    Openness = as.numeric(Openness)
  ) %>%
  dplyr::select(ID, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness, Profession) 

xo = c("~bolditalic(B5[A])", "~bolditalic(B5[C])", "~bolditalic(B5[E])", "~bolditalic(B5[N])", "~bolditalic(B5[O])")

describe(big5_df)

All_big5_plots = big5_df %>%
pivot_longer(cols = -c("ID","Profession"), names_to = "Big5", values_to = "Score") %>%
ggplot(aes(x = Big5, y = Score)) +
geom_boxplot(fill = "white") +
scale_x_discrete(labels = parse(text=xo))+
scale_y_continuous(breaks = seq(2, 10, by = 2)) +
my_theme1 +
labs(x = "", y = "Big-Five Scores")+
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = 0.8, hjust = 0.05, angle = 0,
    position = position_dodge(width = 0.75)
  )


print(All_big5_plots)

detach("package:psych", unload=TRUE)
```

## Plot Cadence PDF
```{r}
plot_cadence_pdf <- all.df3 %>%
  filter(!is.na(PA_Activity)) %>%
  ggplot(aes(x = Cadence, fill = PA_Activity)) +
  geom_density(alpha = 0.6) +
 # my_theme1 +
  theme(legend.position = "top") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold")) +
  theme(legend.title = element_text(size = 5), 
               legend.text = element_text(size = 5)) +
  theme(legend.key.size = unit(0.4, "cm")) +
   labs(x = TeX(r'($\textit{CDN} \ \[SPM/2\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))


print(plot_cadence_pdf)
```



\newpage
### Profession plot

```{r echo=FALSE, fig.height=5, fig.width=5}

prof.plot <- Psych_DF %>%
   filter(ID %in% Selected_P_IDs) %>%
  ungroup() %>%
  dplyr::select(ID, Profession) %>%
  group_by(Profession) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Profession, y = prop, fill = Profession)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Profession Distribution") +
  my_theme1 
  

prof.plot

```

### NASA Total Score Plots

```{r message=FALSE, warning=FALSE}
# EDA for NASA data
# names(all.df3_OD)
# str(all.df3_OD)
NASA_Data = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("NASA_sum"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()


#colSums(is.na(NASA_Data))
tmp_NASA =  NASA_Data %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

Nasa_p1 = NASA_Data %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = NASA_sum, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "NASA_sum") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    #parse = T, size = 5, vjust = -0.75, hjust = -0.75, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p2 = NASA_Data %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = NASA_sum, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )


```


### NASA Mental Demand Plots

```{r message=FALSE, warning=FALSE}
library(psych)

NASA_Data_MD = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_MD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

NASA_Data_MD2 <- na.omit(NASA_Data_MD)

describe.by(NASA_Data_MD2, NASA_Data_MD2$Day)

#colSums(is.na(NASA_Data))
tmp_NASA_MD =  NASA_Data_MD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

Nasa_p1MD = NASA_Data_MD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_MD, fill = Day)) +
  geom_boxplot() +
 # my_theme1 +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{CD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -3.0, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1MD

detach("package:psych", unload=TRUE)
```

### NASA Physical Demand Plots

```{r message=FALSE, warning=FALSE}
library(psych)

NASA_Data_PD = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_PD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_PD =  NASA_Data_PD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_PD

NASA_Data_PD2 <- na.omit(NASA_Data_PD)

describe.by(NASA_Data_PD2, NASA_Data_PD2$Day)

Nasa_p1PD = NASA_Data_PD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_PD, fill = Day)) +
  geom_boxplot() +
 # my_theme1 +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{PD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -3.50, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1PD

detach("package:psych", unload=TRUE)
```


#### NASA Temporal Demand Plots

```{r message=FALSE, warning=FALSE}

# EDA for NASA data
# names(all.df3_OD)
# str(all.df3_OD)
NASA_Data_TD = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_TD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()


#colSums(is.na(NASA_Data))
tmp_NASA_TD =  NASA_Data_TD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

Nasa_p1TD = NASA_Data_TD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_TD, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "N_TD") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    #parse = T, size = 5, vjust = -0.75, hjust = -0.75, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p2TD = NASA_Data_TD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_TD, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )
```

#### NASA Performance Plots

```{r message=FALSE, warning=FALSE}

NASA_Data_P = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_P"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_P =  NASA_Data_P %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

table(tmp_NASA_P$n, tmp_NASA_P$Participant)[,]

Nasa_p1P = NASA_Data_P %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_P, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "N_P") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )


Nasa_p2P = NASA_Data_P %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_P, fill = Profession)) +
  geom_boxplot() +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )
```

#### NASA Effort Plots

```{r message=FALSE, warning=FALSE}

# EDA for NASA data
# names(all.df3_OD)
# str(all.df3_OD)
NASA_Data_E = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_E"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()


#colSums(is.na(NASA_Data))
tmp_NASA_E =  NASA_Data_E %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

#table(tmp_NASA_E$n, tmp_NASA_E$Participant)[,]


Nasa_p1E = NASA_Data_E %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_E, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "N_E") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p2E = NASA_Data_E %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_E, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

```


#### NASA Frustration Plots

```{r message=FALSE, warning=FALSE}

# EDA for NASA data
# names(all.df3_OD)
# str(all.df3_OD)
NASA_Data_F = all.df3_OD %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_F"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_F =  NASA_Data_F %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

Nasa_p1F = NASA_Data_F %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_F, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "N_F") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p2F = NASA_Data_F %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_F, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

```


### Sleep Duration Box Plot
```{r echo=FALSE}
library(psych)

sleep_p1 = all.df3_OD %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Sleep_Time, fill = Day)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "Sleep [h]") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Sleep_df <- all.df3_OD %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct()

Sleep_df

describe(Sleep_df)

sleep_p13 = all.df3_OD %>%
  filter(!is.na(Sleep_Time)) %>%
  #distinct() %>%
  ggplot(aes(x=Sleep_Time)) +
  geom_density(fill = "gray") +
#  my_theme1 +
#  theme(legend.position = "top") +
   labs(x = TeX(r'($\textit{SLEEP} \ \[HR\]$)'),
       y = "PDF"
       ) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"))

sleep_p2 = all.df3_OD %>%
  dplyr::select(Participant, Day, Sleep_Time, Profession) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Sleep_Time, fill = Profession)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "") +
  theme(legend.position = "top") +  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

sleep_p13

detach("package:psych", unload=TRUE)
```

### Cadence Box Plot

```{r echo=FALSE}
candece_p1 = all.df3_OD %>%
  dplyr::select(Participant, Day, Cadence) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Cadence, fill = Day)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "Cadence")+  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

candece_p2 = all.df3_OD %>%
  dplyr::select(Participant, Day, Cadence, Profession) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Cadence, fill = Profession)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "") +
  theme(legend.position = "top")+  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.5, hjust = -0.5, angle = 90,
    position = position_dodge(width = 0.5)
  )
```


# EDA Plots

```{r echo=FALSE, fig.height=5, fig.width=4}
plot_eda_final <- cowplot::plot_grid(plot_cadence_pdf, sleep_p13, Nasa_p1MD, Nasa_p1PD, label_size = 8,
                   labels = c("b1","b2","b3", "b4"), ncol = 2, nrow = 2)


plot_eda_final2 <- cowplot::plot_grid(plot_eda_final, All_big5_plots, label_size = 10,
                   labels = c("", "b5"), ncol = 1, nrow = 2)
                   
plot_eda_final2

plot_file = paste0(plot_dir, "HRV-EDA-Plots.pdf")
ggsave(plot_file, plot_eda_final2, width = 4.0, height = 5.0, dpi = 300)
```


# Collinearity Plot

```{r include=FALSE}
all.df3_OD$Activity3 <-factor(all.df3_OD$Activity3, levels = c("Office.Home","Driving"))
all.df3_OD$Day <- relevel(all.df3_OD$Day, ref = "CD")
all.df3_OD$Period <- factor(all.df3_OD$Period, levels =c("Morning","Afternoon"))

all.df3_OD = merge(all.df3_OD, big5_df, by.x = c("Participant", "Profession"), by.y  = c("ID", "Profession"), x.all = TRUE)

```

```{r fig.height=11, fig.width=11, message=FALSE, warning=FALSE}

library(ggtext)

reduced_data <- subset(all.df3_OD, 
                       select = c(Day, Period, Activity4, Cadence,PA_Percent, PA_AVG_INT,
                                  Sleep_Time, Profession,
                                  N_MD, N_PD, N_TD, N_P, N_E, N_F,
                                  Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness))


reduced_data = rename(reduced_data, c(
"DAY" = "Day", 
"PRD" = "Period",
"ACT" = "Activity4", 
"PA_pc" = "PA_Percent", 
"PA_int" = "PA_AVG_INT", 
"SLEEP" = "Sleep_Time", 
"OCC" = "Profession",
"NASA_MD" = "N_MD", 
"NASA_PD" = "N_PD", 
"NASA_TD" = "N_TD", 
"NASA_P" = "N_P",
"NASA_E" = "N_E", 
"NASA_F" = "N_F", 
"B5_A" = "Agreeableness", 
"B5_C" = "Conscientiousness",
"B5_E" = "Extraversion", 
"B5_N" = "Neuroticism",
"B5_O" = "Openness"))

#correlation_plot = model.matrix(~., data=reduced_data) %>% 
# cor(use="everything") %>% 
 #ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE)

correlation_plot2 <- model.matrix(~., data=reduced_data)
correlation_plot <- cor((correlation_plot2), use="everything") 
colnames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [OD]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")
rownames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [OD]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")

corr.plot <- (ggcorrplot(correlation_plot, show.diag=FALSE, type="lower", lab=TRUE) + theme(axis.text = element_markdown()))

corr.plot_label <- cowplot::plot_grid(corr.plot, label_size = 20,
                   labels = c("b"), ncol = 1, nrow = 1)

corr.plot_label

#corr.plot

plot_file = paste0(plot_dir, "HRV-Stress-Correlation-Plot.pdf")
ggsave(plot_file, corr.plot_label, width = 11.0, height = 11.0, dpi = 300)


library(psych) 

describe(reduced_data)

stargazer::stargazer(reduced_data, type = "text")

library(data.table) 
  
set.seed(1) 
  
# counting frequencies of factor 
# levels 
setDT(reduced_data)[, .N, keyby=ACT] 

```


\newpage

#  Full Logistic Regression Mixed Effects Model (Stress)

```{r echo=FALSE, warning=FALSE}
# Fit the model

stress_logit_model = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Conscientiousness + Extraversion + Neuroticism + Openness + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model)
summ(stress_logit_model, digits=4)

#show random effects
ranef(stress_logit_model)
```



## Remove Agreeableness from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model1 = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_MD + N_PD + N_P + Conscientiousness + Extraversion + Neuroticism + Openness + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model1)
summ(stress_logit_model1, digits=4)
```

## Remove Openness from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model2 = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_MD + N_PD + N_P + Conscientiousness + Extraversion + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model2)
summ(stress_logit_model2, digits=4)
```


## Remove Conscientiousness from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model3 = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_MD + N_PD + N_P + Extraversion + Neuroticism  + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model3)
summ(stress_logit_model3, digits=4)
```


## Remove N_PD from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model4 = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_MD + N_P + Extraversion + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model4)
summ(stress_logit_model4, digits=4)
```


## Remove N_MD from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model5 = glmer(Stress ~  Cadence + Day*Period + Activity4 + PA_Percent + PA_AVG_INT + 
Sleep_Time + Profession + N_P + Extraversion + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model5)
summ(stress_logit_model5, digits=4)
```


## Remove PA_Percent from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model6 = glmer(Stress ~ Cadence + Day*Period + Activity4 + PA_AVG_INT + 
Sleep_Time + Profession + N_P + Extraversion + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model6)
summ(stress_logit_model6, digits=4)
```


## Remove Extraversion from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model7 = glmer(Stress ~ Cadence + Day*Period + Activity4 + PA_AVG_INT + 
Sleep_Time + Profession + N_P + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model7)
summ(stress_logit_model7, digits=4)
```

## Remove PA_AVG_INT  from the Model

```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model7 = glmer(Stress ~ Cadence + Day*Period + Activity4 + 
Sleep_Time + Profession + N_P + Neuroticism + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model7)
summ(stress_logit_model7, digits=4)
```

## Optimal and Scaled Model

```{r}
stress_logit_model_s = glmer(Stress ~  scale(Cadence) + Day*Period + Activity4 +
scale(Sleep_Time) + Profession  + scale(N_P) + scale(Neuroticism ) + (1 | Participant), data = all.df3_OD, family = binomial(link = "logit"))

summary(stress_logit_model_s)
summ(stress_logit_model_s, confint = TRUE, digits=4)

# predictionDat <- tibble(Cadence = c(4.5, 4.5, 4.5, 12), 
#                         Day = c("CD", "CD", "CD", "CD"), 
#                         Period = c("Morning", "Afternoon", "Morning", "Morning"),
#                         Activity3 = c("Office.Home", "Office.Home", "Office.Home", "Office.Home"),
#                         PA_Percent = c(9.1, 9.1, 16, 9.1), Sleep_Time = c(6.8, 6.8, 6.8, 6.8), 
#                         N_MD = c(7.0, 7.0, 7.0, 7.0),
#                         N_P = c(5.8, 5.8, 5.8, 5.8), 
#                         Agreeableness = c(6.1, 6.1, 6.1, 6.1))
# 
# make_predictions(stress_logit_model_s, new_data = predictionDat,
#                  outcome.scale = "response")
```


## Mixed Effects Visualization of Stress Model 
```{r echo=FALSE, fig.height=4.5, fig.width=7}
m.plot.dp <- sjPlot::plot_model(stress_logit_model_s,
                   show.values=TRUE, show.p=TRUE,
                   value.offset = 0.4, 
                   title="") + 
  theme(axis.text = element_text(size = 10)) + theme_bw()

m.plot.dp
```

&nbsp;

## Visualization of Interactions of NHRV Stress Model, if there is interaction


```{r echo=FALSE, fig.height=4.5, fig.width=7}
i.plot.da <- sjPlot::plot_model(stress_logit_model_s,
                   show.values=TRUE, show.p=TRUE, type = "int",
                   title="") + my_theme3 + labs(x = "", y = TeX(r'($\textit{P(S)}$)')) +
  theme(legend.position = "bottom",
  legend.box.margin = margin(-25, 0, 0, 0)) +  scale_color_manual(values = c("magenta","blue")) 

library(ggeffects)

# BEHAV 
i.plot.behav <- ggpredict(stress_logit_model_s,
  terms = c("Activity4")) %>%
  mutate(group = as.factor(c("1", "2", "3"))) %>%
  drop_na() %>%
  gather(key = "key", value = "value", conf.low, conf.high) %>%
  ggplot() +
  geom_line(aes(x = x, y = value, color = group), size = 2) +
  geom_point(aes(x = x, y = predicted, color = group, size = 2)) +
  scale_color_manual(values = c("gray", "red", "red")) +
  my_theme3 + 
  coord_cartesian(ylim = c(0.2, 1)) +  
  scale_x_discrete(labels = c("WRK", TeX(r'($\neg$WRK)'), "DRV")) +
  scale_y_continuous(labels = scales::percent)  +
  labs(x = "", y = TeX(r'($\textit{P(S)}$)'))

# CADENCE
i.plot.cdn <-  ggpredict(stress_logit_model_s, "Cadence[all]") %>%
  ggplot(aes(x, predicted)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  geom_line(colour = "red", size = 2) +
  geom_vline(
    xintercept = mean(all.df3_OD$Cadence, na.rm = TRUE),
    linetype = "dashed",
    color = "gray",
    size = 1
  ) +   my_theme3 + 
  coord_cartesian(ylim = c(0.2, 1)) + 
  scale_y_continuous(labels = scales::percent) +
  #remove y axis labels
  labs(x = TeX(r'($\mu\textit{CDN} \ \[SPM/2\]$)'), y = "")   + theme(axis.text.y = element_blank()) 

i.plot.SDurationQ <- ggpredict(stress_logit_model_s, "Sleep_Time[all]") %>%
  ggplot(aes(x, predicted)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  geom_line(colour = "red", size = 2) +
  geom_vline(
    xintercept = mean(all.df3_OD$Sleep_Time),
    linetype = "dashed",
    color = "gray",
    size = 1
  ) +  my_theme3 + coord_cartesian(ylim = c(0.2, 1)) +  
  scale_y_continuous(labels = scales::percent) +
  labs(x = TeX(r'($\textit{SLEEP} \ \[HR\]$)'), y = "") + theme(axis.text.y = element_blank())
```


```{r echo=FALSE, fig.height=9, fig.width=7, message=FALSE, warning=FALSE}

p_a <- cowplot::plot_grid(
  i.plot.da,
  nrow = 1,
  scale = c(.97),
  labels = c("b1"),
  label_size = 13
) 

p_bcd <- cowplot::plot_grid(
  i.plot.behav, i.plot.cdn, i.plot.SDurationQ,
  nrow = 1,
  scale = c(0.97, .97, .97),
  labels = c("b2", "b3", "b4"),
  label_size = 13
)

final.w.legend <- cowplot::plot_grid(p_a, p_bcd, mylegend,
  nrow = 3,
  rel_heights = c(1.0, 1.0, 0.2)
)

final.w.legend

# save the plot
plot_file = paste0(plot_dir, "HRV-Stress-Model-Plots.pdf")
ggsave(plot_file, final.w.legend, width = 5.5, height = 8, dpi = 300)

levels(all.df3_OD$Participant)
```

