---
title: "NHR Stress Model w/ 3-Way Interaction | N = 24 | 5 min | Thresh = 0 + 2*SD \n | Manual Intervention of Activity4 Classification"
author: "Field Lab |  ACDC Lab"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: united
    number_sections: true 
  pdf_document: 
    toc: true
header-includes:
   - \usepackage{amsmath}
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, #prevents code, but not the results from appearing in the finished file
	message = FALSE, #prevents messages that are generated by code from appearing in the finished file
	warning = FALSE #prevents warnings that are generated by code from appearing in the finished file
)
```


----------

**Step 1: Generate  Stress/No-Stress Labels:** We replace the HR response variable with the binary variable Stress/No-Stress. For that, we generate Stress/No-Stress labels for each 5 min interval based on the HR values and the psycho-physiological definition of stress as instantaneous hyperarousal. If normalized HR does not exhibit severe deviations from normality, then anything to the right of mean could be considered hyperarousal (and thus Stress). The remaining of the distribution could be considered as No-Stress.


**Step 2: Regress on Stress/No-Stress:** Using the Stress/No-Stress binary variable as the response variable, we run a model that provides explanations for the sources of participant stress.


----------

\newpage

```{r Libraries, include=FALSE}
library(tidyverse) # includes ggplot2 dplyr tidyr readr purrr tibble stringr forcats
library(latex2exp) # parses and converts LaTeX math formulas to R's plotmath expressions
library(ggpubr) # facilitates the creation of beautiful ggplot2-based graphs
library(arm)  # convenience functions for regression in R
library(jtools) # efficient presentation of regression analysis, e.g., summ() function
library(ggcorrplot) # visualize easily a correlation matrix using ggplot2
require(ggpmisc) # extension to ggplot2
library(cowplot) # extension to ggplot - arranging plots in a grid
library(hms) # pretty time of day

theme_set(theme_classic()) # set the theme to classic
theme_update(plot.title = element_text(hjust = 0.5)) # center the title

rm(list = ls())
dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(dir)
getwd()
```


```{r SpecialThemes}
# Without x axis label first rows
my_theme <- theme_bw() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 10, face = "bold"),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )

# With  x-y axis label
my_theme1 <- my_theme +
  theme(
    axis.text.x = element_text(size = 8, face = "bold")
  )

mycolors_stress = c(NS = "green", S ="red")

n_fun <- function(x) {
  return(data.frame(y = median(x) * 1.3, label = paste0("~italic(n)", " == ", length(x))))
}

activity_names <- c(
  `sleeping` = "Sleeping",
  `office_home` = "Office Work",
  `walking` = "Walking",
  `running` = "Running",
  `biking` = "Biking",
  `driving` = "Driving"
)

my_theme3 =   theme_bw() +theme(
    panel.grid = element_blank(),
    plot.title = element_text(hjust = 0.5),
    axis.text.x = element_text(size = 10, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    legend.position = "none"
  )

options(digits=4)

data_dir = "../data/"
plot_dir = "../Figures/"
```

```{r SignificanceLegend}
# Create significance legend
levels <- c("A", "S1", "B", "C")
num <- c(5, 10, 15, 20)
ymin <- c(0, 0, 0, 0)
ymax <- c(1, 2, 3, 4)

Legend_DF <- data.frame(levels, num, ymin, ymax)

Legend_Plot <- ggplot(Legend_DF, aes(x = levels, y = num, colour = levels)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), size = 1.1) +
  theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(face = "bold", size = 10),
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.title = element_blank(),
    legend.key.width = unit(1.7, "cm"),
    legend.text = element_text(size = 20)
  ) +
  theme(
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank()
  ) +
  scale_color_manual(
    values = c("black", "cyan", "#ee9a00", "red"),
    breaks = c("A", "S1", "B", "C"),
    labels = c("NS     ", "*     ", "**     ", "***")
  )

mylegend <- ggpubr::get_legend(Legend_Plot)
```


```{r SignalDataReading}
# Read the data
#file <- "../All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL_HRV.csv"

data_dir = "../data/"
#file <- "All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL_Activity4.csv"
file <- "All_Curated_Demog_Activity_Sleep5_min_N24-Manually-Labeled-FINAL_Activity4_Index.csv"

df_raw = read.csv(paste0(data_dir, file), stringsAsFactors = T)

df_validDates <- df_raw %>%
  filter(!is.na(Day_label)) %>%
  filter(!is.na(Time)) %>%
  mutate(Day_label = as.character(Day_label)) 

# for ID = T017, if the Time has "3/29/24" then Day_label = "CD"
df_validDates$Day_label <- ifelse(df_validDates$ID == "T017" & df_validDates$subDC == "DC1.3" & grepl("3/29/24", df_validDates$Time), "MD", df_validDates$Day_label)

#unique(df_validDates$Day_label)
df_validDates$Gender <- NULL
```

```{r AddingSleepLabel, include=FALSE}
unique(df_validDates$Activity4)

df_validDates$Activity4 <- as.factor(df_validDates$Activity4)

df_validDates <- df_validDates %>%
  mutate(Activity4 = recode(Activity4, 
                          "sleeping" = "Sleeping",
                          "Work" = "Work",
                          "NonWork" = "NonWork",
                          "walking" = "Walking",
                          "running" = "Running",
                          "biking" = "Biking",
                          "driving" = "Driving",
                          "unknown" = "Unknown",
                          ))

df_validDates$Activity4 <- factor(df_validDates$Activity4, 
                          levels = c("Work", "NonWork", "Walking", "Running", "Biking", "Driving", "Unknown", "Sleeping"))
levels(df_validDates$Activity4) 

print(table(df_validDates$Activity4, df_validDates$ID, df_validDates$Day_label))
```

```{r FormatTimeLevels, include=FALSE}
df_validDates$Time <- strptime(df_validDates$Time, format = "%Y-%m-%d %H:%M")
df_validDates$Time <- format(df_validDates$Time, format = "%Y-%m-%d %H:%M")
df_validDates$Time <- as.POSIXct(df_validDates$Time, format = "%Y-%m-%d %H:%M")
df_validDates$Time2 <- format(df_validDates$Time, "%H:%M:%S")
df_validDates$Time2 <- as.POSIXct(df_validDates$Time2, format = "%H:%M:%S")

df_validDates$Date <- as.POSIXct(df_validDates$Date, format = "%Y-%m-%d")
df_validDates <- df_validDates %>% 
    filter(Day_label != "NA") %>%
    filter(!is.na(Time)) %>%
  droplevels()

unique(df_validDates$Day_label)
df_validDates$Day_label <- recode_factor(df_validDates$Day_label,
                                  "PR" = "WD", "PR2" = "WD", "PR5" = "WD",
                                  "MD" = "CD", "MD2" = "CD",
                                  "PS" = "WD", "PS2" = "WD",
                                  "RD" = "OD", "RD2" = "OD", "RD3" = "OD"
)

# Day_label reference level is CD
df_validDates$Day_label <- factor(df_validDates$Day_label, levels = c("CD", "WD", "OD"))
levels(df_validDates$Day_label)

df_validDates$Sleep_label <- factor(df_validDates$Sleep_label, levels = c("Not_Sleep", "Sleep"))
levels(df_validDates$Sleep_label)

print(table(df_validDates$Activity4, df_validDates$ID))
print(table(df_validDates$Activity4, df_validDates$ID, df_validDates$Day_label))
```

```{r SedentaryActivities}
df_sedentAct <- df_validDates %>%
  filter(Activity4 %in% c("Work", "NonWork", "Driving")) %>%
  droplevels()
```

```{r PsychDataReading, include=FALSE}
# Read the psychometric data and drop the unnecessary columns based on ID and Date.
fileName = "Exp_NASA_Sleep_N24.csv"
df_rawPsych = read.csv(paste0(data_dir, fileName), stringsAsFactors = T)

# Drop NA in day_label and day_seq
df_validPsych <- df_rawPsych %>%
  drop_na(Day_label, Day_seq) %>%
dplyr::select(ID, Date, Gender,S_duration_Qualtrics, Profession, NASA_sum, N_MD, N_PD, N_TD, N_P, N_E, N_F)

df_multimodal = merge(df_validDates, df_validPsych, 
                     by.x = c("ID","Date"), by.y = c("ID","Date"), all.x = T)

df_multimodal %>% rename("Sleep_Time" = "S_duration_Qualtrics") -> df_multimodal

df_multimodal$Time2 <- format(df_multimodal$Time, "%H:%M:%S")
df_multimodal$Time2 <- as.POSIXct(df_multimodal$Time2, format = "%H:%M:%S")

colSums(is.na(df_multimodal))
df_multimodal <- df_multimodal %>% 
    filter(Day_label != "NA") %>%
    filter(Activity4 != "unknown") %>% droplevels()

df_multimodal$Activity4 = factor(df_multimodal$Activity4, 
                              levels = c("Work", "NonWork", "Walking", "Running", "Biking", "Driving"))

levels(df_multimodal$Activity)
unique(df_multimodal$Activity)

levels(df_multimodal$Activity4) 
unique(df_multimodal$Activity4)
colSums(is.na(df_multimodal))

# Assign proper names to the variables
df_validMultimodal <- df_multimodal %>%
  rename(
  Participant = ID,
  Day = Day_label,
  HR_Normalized = HR_normalized,
  Speed = Speed_NR,
  )

# Remove Unknown activity from consideration
df_validMultimodal <- df_validMultimodal %>% filter(Activity4 != "Unknown")
 
df_validMultimodal <- df_validMultimodal %>% drop_na(Day)

unique(df_validMultimodal$Activity4)

# Create  PA_Activity variable - Sedentary and PA
df_validMultimodal$PA_Activity <- NA # as.character(df_validDates$max_ind)

df_validMultimodal[df_validMultimodal$Activity4 == "Work",]$PA_Activity =  "Sedentary"
df_validMultimodal[df_validMultimodal$Activity4 == "NonWork",]$PA_Activity =  "Sedentary"
df_validMultimodal[df_validMultimodal$Activity4 == "Driving",]$PA_Activity =  "Sedentary"

df_validMultimodal[df_validMultimodal$Activity4 == "Walking",]$PA_Activity =  "PA"
df_validMultimodal[df_validMultimodal$Activity4 == "Running",]$PA_Activity =  "PA"
df_validMultimodal[df_validMultimodal$Activity4 == "Biking",]$PA_Activity =  "PA"

# Day reference level is CD
df_validMultimodal$Day <- relevel(df_validMultimodal$Day, ref = "CD")
```


# Physical Acitvity (PA) Per Participant & Day
```{r PhysicalActivityComputations, echo=FALSE}
library(psych)


T025_df = df_validMultimodal %>% 
 filter(Participant %in% sprintf("T%03d", 25) )

# Calculate PA_Percent 
PA_Percent_Summary <- df_validMultimodal %>% 
  group_by(Participant, Day) %>%
  summarise(nT = sum(Activity4 == "Work"| Activity4 == "NonWork"| Activity4 == "Driving"| Activity4 == "Running" | Activity4 == "Walking" | Activity4 == "Biking", na.rm = TRUE), PA_Percent = sum(Activity4 == "Walking" | Activity4 == "Running" | Activity4 == "Biking", na.rm = TRUE) *100 / nT
  )  %>%
  ungroup() %>%
  mutate(total_n = sum(nT)) # add df len with

PA_Percent_Summary = PA_Percent_Summary %>% # remove the total_n column
  dplyr::select(-total_n) 

# Calculate PA_Intensity
PA_Intensity_Summary = df_validMultimodal %>%
  group_by(Participant, Day) %>%
  filter(Activity4 %in% c("Walking", "Running", "Biking")) %>%
  summarise(
    PA_Intensity = round(mean(Cadence, na.rm=TRUE),1) # mean Cadence per day per subject
  ) 

All_Summary = merge(PA_Percent_Summary, PA_Intensity_Summary, by = c("Participant", "Day"), all.x = T) 

All_Summary 

describe(All_Summary )


detach("package:psych", unload=TRUE)
```

# Frequencies of Sedentary Activities Per Day and Participant
```{r StressThresholdComputations}
# Calculate Stress Threshold
all.df3_nPA = df_validMultimodal %>%
  group_by(Participant, Day) %>%
  filter(Activity4 %in% c("Work", "NonWork", "Driving")) %>%
  mutate(
   NHR_0_2SD = round(2.0*sd(HR_Normalized,na.rm=TRUE),1),
   NHR_Median = round(median(HR_Normalized,na.rm=TRUE),1),
  ) %>% droplevels()
  
# Use Normalized HR, 2*SD, and Median  for stress labeling
df_sedentAct = merge(all.df3_nPA, All_Summary, by = c("Participant", "Day"), all.x = T)

df_sedentAct$PA_Intensity[is.na(df_sedentAct$PA_Intensity)] <- 0

df_sedentAct <- df_sedentAct %>%
  group_by(Participant, Day) %>%
  mutate(
    Stress = ifelse(HR_Normalized > NHR_0_2SD, "S", "NS"), # 0 + 2*SD is the threshold
    # percent of "S" in Stress
    Stress_Percent = sum(Stress == "S", na.rm = TRUE) *100 / n()
  )

df_sedentAct$Stress <- as.factor(df_sedentAct$Stress)

table(df_sedentAct$Participant, df_sedentAct$Activity4, df_sedentAct$Day)
```

```{r eval=FALSE, include=FALSE}
# Save as csv file
#write.csv(df_sedentAct, "../Stress_model_data_OH_DR_N24.csv", row.names = F)
```

# Distrubution of NHR in Sedentary Activities
```{r hr_normalized_pdf}
df_sedentAct %>%
  filter(Activity4 %in% c("Work", "NonWork", "Driving")) %>%
  ggplot(aes(x = HR_Normalized, fill = Activity4)) +
  geom_density(alpha = 0.5) +
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = TeX(r'($\Delta$HR \[BPM\])'),
       y = "PDF") 
```

# Viz of Stress Distribution and QQ Plots for T025
```{r stress_threshold_viz_t025, echo=FALSE, fig.height=4, fig.width=4}
# Create a complete grid of Participant and Day combinations
complete_grid <- expand_grid(
  Participant = sprintf("T%03d", 1:25), 
  Day = c("CD", "WD", "OD")
)

complete_grid$Day = factor(complete_grid$Day, levels = c("CD", "WD", "OD"))

# Ensure all combinations are present in the data
df_sedentActForm <- complete_grid %>%
  left_join(df_sedentAct, by = c("Participant", "Day"))

# T025
 plot_stress_distr <- df_sedentActForm %>% 
 filter(Participant %in% sprintf("T%03d", 25) ) %>%
 ggplot(aes(x = HR_Normalized, fill = Stress)) +
 scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
 geom_histogram( position = "dodge", binwidth = 1) +
 facet_wrap(~Participant+Day, ncol = 3) +
 my_theme1 +
 scale_x_continuous(breaks = seq(-10, 40, by = 10)) +
 theme(legend.position = "none") +
 labs(x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
 geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

# Create qq plots for T025 of Day
plot_stress_qq <- df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 25) ) %>%
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3) +
  theme(legend.position = "none")

plot_stress_label <- cowplot::plot_grid(plot_stress_distr, plot_stress_qq, label_size = 8,
                   labels = c("a1","a2"), ncol = 1, nrow = 2)

plot_stress_label

#ggsave("HR-Stress-Label-Plots.pdf", plot_stress_label, width = 4.0, height = 4.0, dpi = 300)

plot_file = paste0(plot_dir, "HR-Stress-Label-Plots.pdf")
ggsave(plot_file, plot_stress_label, width = 4.0, height = 4.0, dpi = 300)

library(psych)

df_sedentActForm %>%
  ungroup() %>%
  filter(Participant %in% sprintf("T%03d", 1) ) %>%
  group_by(Day) %>%
  dplyr::select(Participant,Day, HR_Normalized, PA_Percent, PA_Intensity) %>%
  distinct() %>%
  ungroup() %>%
  psych::describe()

detach("package:psych", unload=TRUE)
```

## Viz of Stress Distribution per Participant and Day
```{r stress_threshold_viz, echo=FALSE, fig.height=11, fig.width=11}
# T001, T002, T003, T004, T005, T006
df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(x = HR_Normalized, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, black line = 0+2SD, blue line = Median",
       x = TeX(r'($\Delta$HR \[BPM\])'), y = "Frequency") +
  geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r stress_threshold_viz2, echo=FALSE, fig.height=11, fig.width=11}
# T007, T008, T009, T010, T011, T012
df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, black line = 0+2SD, blue line = Median",
       x = TeX(r'($\Delta$HR \[BPM\])'), y = "Frequency") +
  geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 


df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r stress_threshold_viz3, echo=FALSE, fig.height=11, fig.width=11}
# T013, T014, T015, T016, T017, T018
df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, black line = 0+2SD, blue line = Median",
       x = TeX(r'($\Delta$HR \[BPM\])'), y = "Frequency") +
  geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r stress_threshold_viz4, echo=FALSE, fig.height=11, fig.width=11}
# T019, T020, T021, T022, T023, T024, T025
df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, black line = 0+2SD, blue line = Median",
       x = TeX(r'($\Delta$HR \[BPM\])'), y = "Frequency") +
  geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentActForm %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

# PA_Percent Plot
```{r echo=FALSE}
plot_PA_Percent = df_sedentAct %>%
  group_by(Participant, Day) %>%
  dplyr::select(Participant,Day,PA_Percent) %>%
  distinct() %>%
ggplot(aes(x = Day, y = PA_Percent/100, fill = Day)) +
geom_boxplot() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "", y = "PA", title = "") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -2.00, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

plot_PA_Percent
```


```{r stress_counts, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 1:6)

df_sedentAct %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(nT),
    prop = nT / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent, linetype = "PA_Percent"), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  scale_linetype_manual(values = c("PA_Percent" = 2)) +
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%", title = "--- PA_Percent")
```

```{r stress_counts2, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 7:12)

df_sedentAct %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(nT),
    prop = nT / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r stress_counts3, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 14:18)

df_sedentAct %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(nT),
    prop = nT / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r stress_counts4, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 19:25)

df_sedentAct %>%
  filter(Participant %in% tmp_P_list ) %>% 
  mutate(Stress_percent = round(Stress_Percent, 1)) %>%
  mutate(
    # Filter participants and adjust factor levels to match the filtered dataset
    Participant = factor(Participant, levels = tmp_P_list),
    sum_n = sum(nT),
    prop = nT / sum_n
  ) %>%
  ggplot(aes(x = Stress, y= prop*100, fill = Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```

\newpage

```{r echo=FALSE}
Selected_P_IDs = sprintf("T%03d", 1:25)
# Exclude T001, T002, T005, T009, T011, T019, T021
#Selected_P_IDs = Selected_P_IDs[-c(1,2,5,9,11,19,21)]

#Selected_P_IDs
df_sedentAct <- df_sedentAct %>%
  filter(Participant %in% Selected_P_IDs) %>%
  droplevels()

#table(df_sedentAct$Participant, df_sedentAct$Day)
```


# Big 5 Box Plots
```{r echo=FALSE, fig.height=5, fig.width=7, message=FALSE, warning=FALSE}
# Read the sheet and drop the unnecessary columns based on ID and Date.
library("readxl")
library(psych)

Experimenter_data_sheet2 = read_csv(paste0(data_dir, "ExperimenterNotes-FieldLAB - Big-5.csv"))

#str(Experimenter_data_sheet2)
names(Experimenter_data_sheet2)[1] <- "ID"

Profession = df_validPsych %>% 
  group_by(Profession) %>%
  dplyr::select(ID, Profession) %>%
  distinct() 
  
Experimenter_data_sheet2 = merge(Experimenter_data_sheet2, Profession, by = "ID")

big5_df = Experimenter_data_sheet2 %>%
  drop_na(ID) %>%
  mutate(
    ID = as.character(ID),
    Agreeableness = as.numeric(Agreeableness),
    Conscientiousness = as.numeric(Conscientiousness),
    Extraversion = as.numeric(Extraversion),
    Neuroticism = as.numeric(Neuroticism),
    Openness = as.numeric(Openness)
  ) %>%
  dplyr::select(ID, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness, Profession) 

xo = c("~bolditalic(B5[A])", "~bolditalic(B5[C])", "~bolditalic(B5[E])", "~bolditalic(B5[N])", "~bolditalic(B5[O])")

describe(big5_df)

All_big5_plots = big5_df %>%
pivot_longer(cols = -c("ID","Profession"), names_to = "Big5", values_to = "Score") %>%
ggplot(aes(x = Big5, y = Score)) +
geom_boxplot(fill = "white") +
scale_x_discrete(labels = parse(text=xo))+
scale_y_continuous(breaks = seq(2, 10, by = 2)) +
my_theme1 +
labs(x = "", y = "Big-Five Scores")+
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -0.1, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

print(All_big5_plots)

detach("package:psych", unload=TRUE)
```

# Cadence PDF
```{r}
library(psych)

plot_cadence_pdf <- df_validMultimodal %>% filter(!is.na(Cadence)) %>%
  filter(!is.na(PA_Activity)) %>%
  ggplot(aes(x = Cadence, fill = PA_Activity)) +
  geom_density(alpha = 0.6) +
 # my_theme1 +
  theme(legend.position = "top") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold")) +
  theme(legend.title = element_text(size = 5), 
               legend.text = element_text(size = 5)) +
  theme(legend.key.size = unit(0.4, "cm")) +
   labs(x = TeX(r'($\textit{CDN} \ \[SPM/2\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

print(plot_cadence_pdf)

df_validMultimodal %>% filter(!is.na(Cadence)) %>%
 filter(PA_Activity == "Sedentary") %>%   filter(!is.na(PA_Activity)) %>% describe()

df_validMultimodal %>% filter(!is.na(Cadence)) %>%
 filter(PA_Activity == "PA") %>%   filter(!is.na(PA_Activity)) %>% describe()

detach("package:psych", unload=TRUE)
```

\newpage

# Profession Plot
```{r echo=FALSE, fig.height=5, fig.width=5}
prof.plot <- df_validPsych %>%
  ungroup() %>%
  dplyr::select(ID, Profession) %>%
  group_by(Profession) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Profession, y = prop, fill = Profession)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Profession Distribution") +
  my_theme1 

prof.plot
```

# NASA Mental Demand Plot
```{r message=FALSE, warning=FALSE}
library(psych)

NASA_Data_MD =# df_sedentAct %>% 
  df_validMultimodal %>% 
  #dplyr::select(starts_with("N_MD"), Profession) %>%
  dplyr::select(Participant, Day, Date,starts_with("N_MD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

#colSums(is.na(NASA_Data))
tmp_NASA_MD =  NASA_Data_MD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_MD2 <- na.omit(NASA_Data_MD)

describe.by(NASA_Data_MD2, NASA_Data_MD2$Day)

nlabels <- table(NASA_Data_MD2$Day)

#  To create the median labels, you can use by
meds <- c(by(NASA_Data_MD2$N_MD, NASA_Data_MD2$Day, median))

myPlot <- ggplot(NASA_Data_MD2, aes(Day, N_MD, label=rownames(NASA_Data_MD2))) +
   geom_boxplot(fill = "grey80", colour = "#3366FF") + 
   geom_text(data = data.frame(), aes(x = names(meds) , y = meds + 1, 
            label = paste("n =", nlabels)))
   
myPlot
 
Nasa_p1MD = NASA_Data_MD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_MD, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{MD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -2.00, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1MD

detach("package:psych", unload=TRUE)
```

# NASA Physical Demand Plot
```{r message=FALSE, warning=FALSE}
library(psych)

NASA_Data_PD =
  df_validMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_PD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_PD =  NASA_Data_PD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_PD2 <- na.omit(NASA_Data_PD)

describe.by(NASA_Data_PD2, NASA_Data_PD2$Day)

Nasa_p1PD = NASA_Data_PD2 %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_PD, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{PD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -3.50, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1PD

detach("package:psych", unload=TRUE)
```

# NASA Temporal Demand Plot
```{r message=FALSE, warning=FALSE}

NASA_Data_TD = df_validMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_TD"), Profession) %>%
  #dplyr::select(starts_with("N_TD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_TD =  NASA_Data_TD %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_TD2 <- na.omit(NASA_Data_TD)

Nasa_p1TD = NASA_Data_TD2 %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_TD, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  #theme(legend.position = "top") +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{TD}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{TD}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 0.5, hjust = 0.5, angle = 0,
    #parse = T, size = 5, vjust = -0.75, hjust = -0.75, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p2TD = NASA_Data_TD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_TD, fill = Profession)) +
  geom_boxplot() +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p1TD
```

# NASA Performance Plot
```{r message=FALSE, warning=FALSE}

NASA_Data_P = df_validMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_P"), Profession) %>%
  #dplyr::select(starts_with("N_P"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

tmp_NASA_P =  NASA_Data_P %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

table(tmp_NASA_P$n, tmp_NASA_P$Participant)[,]

NASA_Data_P2 <- na.omit(NASA_Data_P)

Nasa_p1P = NASA_Data_P2 %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_P, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{P}}$)')) +# geom_point() + ylim(c(1, 20)) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = 6.50, hjust = -1.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p2P = NASA_Data_P %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_P, fill = Profession)) +
  geom_boxplot() +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p1P
```

# NASA Effort Plot
```{r message=FALSE, warning=FALSE}
NASA_Data_E = df_validMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_E"), Profession) %>%
  #dplyr::select(starts_with("N_E"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

#colSums(is.na(NASA_Data))
tmp_NASA_E =  NASA_Data_E %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_E2 <- na.omit(NASA_Data_E)

Nasa_p1E = NASA_Data_E2 %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_E, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  
  labs(x = "", y = TeX(r'($\textit{NASA_{E}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{E}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 1.5, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p2E = NASA_Data_E %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_E, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p1E 
```

# NASA Frustration Plot
```{r message=FALSE, warning=FALSE}
NASA_Data_F = df_validMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_F"), Profession) %>%
  #dplyr::select(starts_with("N_F"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  distinct()

#diff_NASA_Data_F_not_in_NASA_Data <- anti_join(NASA_Data_F, NASA_Data)

tmp_NASA_F =  NASA_Data_F %>%
  ungroup() %>%
  dplyr::select(Participant, Day) %>%
  group_by(Participant) %>%
  count(Participant) %>%
  distinct()

NASA_Data_F2 <- na.omit(NASA_Data_F)

Nasa_p1F = NASA_Data_F2 %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_F, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  
  labs(x = "", y = TeX(r'($\textit{NASA_{F}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{F}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 1.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p2F = NASA_Data_F %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_F, fill = Profession)) +
  geom_boxplot() +
  #facet_wrap(~Profession ) +
  my_theme1 +
scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  labs(x = "", y = "") +
  theme(legend.position = "top") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p1F
```

# Sleep Duration PDF
```{r echo=FALSE}
library(psych)

sleep_p1 = df_sedentAct %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Sleep_Time, fill = Day)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "Sleep [h]") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Sleep_df <- df_sedentAct %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct()

Sleep_df

describe(Sleep_df)

sleep_p13 = df_sedentAct %>%
  filter(!is.na(Sleep_Time)) %>%
  #distinct() %>%
  ggplot(aes(x=Sleep_Time)) +
  geom_density(fill = "gray") +
  labs(x = TeX(r'($\textit{SLEEP} \ \[HR\]$)'),
       y = "PDF"
       ) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"))

sleep_p2 = df_sedentAct %>%
  dplyr::select(Participant, Day, Sleep_Time, Profession) %>%
  distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Sleep_Time, fill = Profession)) +
  geom_boxplot()+
  labs(x = "", y = "") +
  theme(legend.position = "top") +  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 90,
    position = position_dodge(width = 0.75)
  )

sleep_p13

detach("package:psych", unload=TRUE)
```

# mCadence Plot
```{r echo=FALSE}
library(psych)

describe(df_sedentAct)

mCadence_p1 = df_sedentAct %>%
  #filter(!is.na(PA_Intensity)) %>%
  #distinct() %>%
  ggplot(aes(x=Cadence)) +
  geom_density(fill = "black") +
  my_theme1 +
  theme(legend.position = "top") +
   labs(x = TeX(r'($\textit{mCadence} \ \[SPM/2\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

mCadence_p1

detach("package:psych", unload=TRUE)
```

# mCadence Box Plot
```{r echo=FALSE}
candece_p1 = df_sedentAct %>%
  dplyr::select(Participant, Day, Cadence) %>%
  #distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Cadence, fill = Day)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "Cadence")+  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

candece_p2 = df_sedentAct %>%
  dplyr::select(Participant, Day, Cadence, Profession) %>%
  #distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Cadence, fill = Profession)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = "") +
  theme(legend.position = "top")+  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.5, hjust = -0.5, angle = 90,
    position = position_dodge(width = 0.5)
  )

candece_p1
```

# EDA Plots
```{r EDA_Plots, echo=FALSE, fig.height=5, fig.width=4}
plot_eda_final <- cowplot::plot_grid(plot_cadence_pdf, plot_PA_Percent, Nasa_p1MD, Nasa_p1P, label_size = 8,
                   labels = c("a1","a2","a3", "a4"), ncol = 2, nrow = 2)


plot_eda_final2 <- cowplot::plot_grid(plot_eda_final, All_big5_plots, label_size = 10,
                   labels = c("", "a5"), ncol = 1, nrow = 2)
                   
plot_eda_final2

ggsave("NHR-EDA-Plots.pdf", plot_eda_final2, width = 4.0, height = 5.0, dpi = 300)

plot_file = paste0(plot_dir, "NHR-EDA-Plots.pdf")
ggsave(plot_file, plot_eda_final2, width = 4.0, height = 5.0, dpi = 300)
```

# Collinearity Plot
```{r include=FALSE}
df_sedentAct$Activity4 <-factor(df_sedentAct$Activity4, levels = c("Work","NonWork","Driving"))
df_sedentAct$Day <- relevel(df_sedentAct$Day, ref = "CD")
df_sedentAct$Period <- factor(df_sedentAct$Period, levels =c("Morning","Afternoon"))

df_sedentAct = merge(df_sedentAct, big5_df, by.x = c("Participant", "Profession"), by.y  = c("ID", "Profession"), x.all = TRUE)
```

```{r fig.height=11, fig.width=11, message=FALSE, warning=FALSE}
library(ggtext)
library(psych)

reduced_data <- subset(df_sedentAct, 
                       select = c(Day, Period, Activity4, Cadence,PA_Percent, PA_Intensity, 
                                  Sleep_Time, Profession,
                                  N_MD, N_PD, N_TD, N_P, N_E, N_F,
                                  Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness))


reduced_data = rename(reduced_data, c(
"DAY" = "Day", 
"PRD" = "Period",
"ACT" = "Activity4", 
"PA_pc" = "PA_Percent", 
"PA_int" = "PA_Intensity", 
"SLEEP" = "Sleep_Time", 
"OCC" = "Profession",
"NASA_MD" = "N_MD", 
"NASA_PD" = "N_PD", 
"NASA_TD" = "N_TD", 
"NASA_P" = "N_P",
"NASA_E" = "N_E", 
"NASA_F" = "N_F", 
"B5_A" = "Agreeableness", 
"B5_C" = "Conscientiousness",
"B5_E" = "Extraversion", 
"B5_N" = "Neuroticism",
"B5_O" = "Openness"))

correlation_plot2 <- model.matrix(~., data=reduced_data)
correlation_plot <- cor((correlation_plot2), use="everything") 
colnames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [OD]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")
rownames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [OD]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")

corr.plot <- (ggcorrplot(correlation_plot, show.diag=FALSE, type="lower", lab=TRUE) + theme(axis.text = element_markdown()))

corr.plot_label <- cowplot::plot_grid(corr.plot, label_size = 20,
                   labels = c("a"), ncol = 1, nrow = 1)

corr.plot_label


#ggsave("HR-Stress-Correlation-Plot.pdf", corr.plot_label, width = 11.0, height = 11.0, dpi = 300)

plot_file = paste0(plot_dir, "HR-Stress-Correlation-Plot.pdf")
ggsave(plot_file, corr.plot_label, width = 11.0, height = 11.0, dpi = 300)

## Descriptive Statistics 

reduced_data_B5 <- subset(df_sedentAct, 
        select = c(Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness
                   )
        )

reduced_data_B5 = reduced_data_B5 %>% 
  distinct()


# reduced_data_NASA <- subset(df_sedentAct, 
#         select = c(
#                    N_MD, N_PD, N_TD, N_P, N_E, N_F)
#         )
# 
# reduced_data_NASA = reduced_data_NASA %>% 
#   distinct()

describe(reduced_data_B5)
#describe(reduced_data_NASA)

stargazer::stargazer(reduced_data_B5, type = "text")
#stargazer::stargazer(reduced_data_NASA, type = "text")


# describe(reduced_data)
# stargazer::stargazer(reduced_data, type = "text")

library(data.table) 
  
set.seed(1) 
  
# counting frequencies of factor 
# levels 
setDT(reduced_data)[, .N, keyby=ACT] 

detach("package:psych", unload=TRUE)
```

\newpage

# Full Logistic Regression Mixed Effects Model (Stress from NHR)
```{r echo=FALSE, warning=FALSE}
# Fit the model
## PA_Intensity has 23 subjects, T008 all days have NA for PA_Intensity

library(sjPlot)
library(sjmisc)

stress_logit_model = glmer(Stress ~  Cadence + Day*Period + Activity4 + Day*PA_Percent*PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Conscientiousness + Extraversion + Neuroticism + Openness + (1 | Participant), data = df_sedentAct, family = binomial(link = "logit"))

summary(stress_logit_model)
summ(stress_logit_model, digits=4)

#show random effects
ranef(stress_logit_model)

m.plot.main1 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Cadence[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main2 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main3 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Activity4[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main4 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_MD[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main5 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_PD[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main6 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_P[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main7 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Extraversion[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.2way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "Period[all]")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.3way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "PA_Percent[4.43, 17.68]", "PA_Intensity")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main1

m.plot.main2

m.plot.main3

m.plot.main4

m.plot.main5

m.plot.main6

m.plot.main7

m.plot.2way

m.plot.3way
```

# Remove Conscientiousness from the Model
```{r echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model1 = glmer(Stress ~ Cadence + Day*Period + Activity4 + Day*PA_Percent*PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Extraversion + Neuroticism + Openness + (1 | Participant), data = df_sedentAct, family = binomial(link = "logit"))

summary(stress_logit_model1)
summ(stress_logit_model1, digits=4)
```

# Optimal and Scaled Model
```{r}
#   data$s_variable <- scale(data$original_variable)

df_sedentAct$s_Cadence <- scale(df_sedentAct$Cadence)
df_sedentAct$s_PA_Percent <- scale(df_sedentAct$PA_Percent)
df_sedentAct$s_PA_Intensity <- scale(df_sedentAct$PA_Intensity)
df_sedentAct$s_Sleep_Time <- scale(df_sedentAct$Sleep_Time)
df_sedentAct$s_N_MD <- scale(df_sedentAct$N_MD)
df_sedentAct$s_N_PD <- scale(df_sedentAct$N_PD)
df_sedentAct$s_N_P <- scale(df_sedentAct$N_P)
df_sedentAct$s_Agreeableness <- scale(df_sedentAct$Agreeableness)
df_sedentAct$s_Extraversion <- scale(df_sedentAct$Extraversion)
df_sedentAct$s_Neuroticism <- scale(df_sedentAct$Neuroticism)
df_sedentAct$s_Openness <- scale(df_sedentAct$Openness)


stress_logit_model_s = glmer(Stress ~  s_Cadence + Day*Period + Activity4 + Day*s_PA_Percent*s_PA_Intensity + s_Sleep_Time + Profession + s_N_MD + s_N_PD + s_N_P + s_Agreeableness + s_Extraversion + s_Neuroticism + s_Openness + (1 | Participant), data = df_sedentAct, family = binomial(link = "logit"))

summary(stress_logit_model_s)
summ(stress_logit_model_s, confint = TRUE, digits=4)
```

# Mixed Effects Visualization of Stress Model 
```{r echo=FALSE, fig.height=4.5, fig.width=7}
m.plot.main_cdn <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   terms = c("s_Cadence[all]"),
                   colors = "black",
                   title = "") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main_cdn 

m.plot.main_day <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]"),
                   colors = "black",
                   title = "") +
                   theme_bw() +
                   theme(
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main_day

m.plot.main_act <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   terms = c("Activity4[all]"),
                   colors = "black",
                   title = "") +
                   theme_bw() +
                   theme(
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main_act

m.plot.main_nmd <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   terms = c("s_N_MD[all]"),
                   colors = "black",
                   title = "") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.main_nmd

m.plot.2way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   terms = c("Day[all]", "Period[all]")) +
                   set_theme (
                     base = theme_bw(),
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                     axis.text = element_text(size = 10),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank())

m.plot.2way

m.plot.3way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   terms = c("Day[all]", "s_PA_Percent[-1, 1]", "s_PA_Intensity[-1, 1]")) +
                   set_theme (
                     base = theme_bw(),
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())

m.plot.3way
```

&nbsp;



```{r eval=FALSE, echo=FALSE, fig.height=4.5, fig.width=7}
 # Visualization of Interactions of HR Stress Model, if there is interaction

 # i.plot.da <- sjPlot::plot_model(stress_logit_model_s,
 #                    show.values=TRUE, show.p=TRUE, type = "int",
 #                    title="") + my_theme3 + labs(x = "", y = TeX(r'($\textit{P(S)}$)')) +
 #  theme(legend.position = "bottom",
 #  legend.box.margin = margin(-25, 0, 0, 0)) +  scale_color_manual(values = c("magenta","blue")) 

library(ggeffects)

#detach("package:ggpubr", unload = TRUE)

# BEHAV 
i.plot.behav <- ggpredict(stress_logit_model_s,
  terms = c("Activity4")) %>%
  mutate(group = as.factor(c("1", "2", "3"))) %>%
  drop_na() %>%
  gather(key = "key", value = "value", conf.low, conf.high) %>%
  ggplot() +
  geom_line(aes(x = x, y = value, color = group), size = 2) +
  geom_point(aes(x = x, y = predicted, color = group, size = 2)) +
  scale_color_manual(values = c("gray", "red", "black")) +
  my_theme3 + 
  coord_cartesian(ylim = c(0.1, 1)) +  
  scale_x_discrete(labels = c("WRK", TeX(r'($\neg$WRK)'), "DRV")) +
  scale_y_continuous(labels = scales::percent)  +
  labs(x = "", y = TeX(r'($\textit{P(S)}$)'))

# CADENCE
i.plot.cdn <-  ggpredict(stress_logit_model_s, "Cadence[all]") %>%
  ggplot(aes(x, predicted)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  geom_line(colour = "red", size = 2) +
  geom_vline(
    xintercept = mean(df_sedentAct$Cadence, na.rm = TRUE),
    linetype = "dashed",
    color = "gray",
    size = 1
  ) +   my_theme3 + 
  coord_cartesian(ylim = c(0.1, 1)) + 
  scale_y_continuous(labels = scales::percent) +
  #remove y axis labels
  labs(x = TeX(r'($\mu\textit{CDN} \ \[SPM/2\]$)'), y = "")   + theme(axis.text.y = element_blank()) 

# PA_Percent
# i.plot.PA_Percent <- ggpredict(stress_logit_model_s, "PA_Percent[all]") %>%
#   ggplot(aes(x, predicted)) +
#   geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
#   geom_line(colour = "red", size = 2) +
#   geom_vline(
#     xintercept = mean(df_sedentAct$PA_Percent),
#     linetype = "dashed",
#     color = "gray",
#     size = 1
#   ) +  my_theme3 + coord_cartesian(ylim = c(0.1, 1)) +  
#   scale_y_continuous(labels = scales::percent) +
#   labs(x = TeX(r'($\textit{Percent PA} \ \[\]$)'), y = "") + theme(axis.text.y = element_blank()) 
```



```{r echo=FALSE, fig.height=9, fig.width=7, message=FALSE, warning=FALSE}

p_a <- cowplot::plot_grid(
  m.plot.2way,
  nrow = 1,
  scale = c(.97),
  labels = c("a1"),
  label_size = 13
) 

p_bcd <- cowplot::plot_grid(
  m.plot.main_cdn, m.plot.main_act, m.plot.main_nmd,
  nrow = 1,
  scale = c(0.97, .97, .97),
  labels = c("a2", "a3", "a4"),
  label_size = 13
)

p_e <- cowplot::plot_grid(
  m.plot.3way,
  nrow = 1,
  scale = c(.97),
  labels = c("a5"),
  label_size = 13
) 

final.w.legend <- cowplot::plot_grid(p_a, p_e, p_bcd, mylegend, 
  nrow = 4,
  rel_heights = c(3.0, 3.0, 3.0, 02)
)

final.w.legend

# save the plot
plot_file = paste0(plot_dir, "HR-Stress-Model-Plots.pdf")
ggsave(plot_file, final.w.legend, width = 5.5, height = 8, dpi = 300)

levels(df_sedentAct$Participant)
```

