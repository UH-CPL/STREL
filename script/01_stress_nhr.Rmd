---
title: "NHR Stress Model w/ 3-Way Interaction | N = 24 | 5 min | Thresh = 0 + 2*SD \n | Manual Intervention of Activity4 Classification"
author: "Field Lab |  ACDC Lab"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: united
    number_sections: true 
  pdf_document: 
    toc: true
header-includes:
   - \usepackage{amsmath}
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, #prevents code, but not the results from appearing in the finished file
	message = FALSE, #prevents messages that are generated by code from appearing in the finished file
	warning = FALSE #prevents warnings that are generated by code from appearing in the finished file
)
```


----------

**Step 1: Generate  Stress/No-Stress Labels:** We replace the HR response variable with the binary variable Stress/No-Stress. For that, we generate Stress/No-Stress labels for each 5 min interval based on the HR values and the psycho-physiological definition of stress as instantaneous hyperarousal. If normalized HR does not exhibit severe deviations from normality, then anything to the right of mean could be considered hyperarousal (and thus Stress). The remaining of the distribution could be considered as No-Stress.


**Step 2: Regress on Stress/No-Stress:** Using the Stress/No-Stress binary variable as the response variable, we run a model that provides explanations for the sources of participant stress.


----------

\newpage

```{r Libraries, include=FALSE}
library(tidyverse) # includes ggplot2 dplyr tidyr readr purrr tibble stringr forcats
library(latex2exp) # parses and converts LaTeX math formulas to R's plotmath expressions
library(ggpubr) # facilitates the creation of beautiful ggplot2-based graphs
library(arm)  # convenience functions for regression in R
library(jtools) # efficient presentation of regression analysis, e.g., summ() function
library(ggcorrplot) # visualize easily a correlation matrix using ggplot2
require(ggpmisc) # extension to ggplot2
library(cowplot) # extension to ggplot - arranging plots in a grid
library(hms) # pretty time of day

theme_set(theme_classic()) # set the theme to classic
theme_update(plot.title = element_text(hjust = 0.5)) # center the title

rm(list = ls())
dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(dir)
getwd()
```


```{r SpecialThemes, message=FALSE, warning=FALSE}
# load the utility script
source("../script/Utility_Script.R")

activity_names <- c(
  `sleeping` = "Sleeping",
  `office_home` = "Office Work",
  `walking` = "Walking",
  `running` = "Running",
  `biking` = "Biking",
  `driving` = "Driving"
)

options(digits=3)

data_dir = "../data/" # data directory
plot_dir = "../figures/" # plot directory
```



```{r ReadData, include=FALSE}
# Load the data
df = read.csv("../data/Activity_Stress_data_N24.csv", stringsAsFactors = T)

str(df)

colSums(is.na(df))
unique(df$Activity4)
df$Activity4 = as.character(df$Activity4)

#remove unknown activity which is not used in the analysis
df <- df %>%
  filter (Activity4!= "Unknown")


# reunion of the two WD1 and WD2 days as WD.
df$Day <- recode_factor(df$Day,
                                  "WD1" = "WD", "WD2" = "WD", 
                                  "CD" = "CD", "ND" = "ND"
)

df$Day = factor(df$Day, levels = c("CD", "WD", "ND"))


df$PA_Activity = as.character(df$PA_Activity)
df[df$Activity4 == "Walking",]$PA_Activity =  "PA"
df[df$Activity4 == "Running",]$PA_Activity =  "PA"
df[df$Activity4 == "Biking",]$PA_Activity =  "PA"


df$PA_Activity = factor(df$PA_Activity, levels = c("Sedentary", "PA"))
# recode activities slow to fast.
df$Activity4 = factor(df$Activity4, levels = c("Work", "NonWork", "Walking", "Running", "Biking", "Driving"))

# create sedentary data
df_sedentMultimodal = df %>%
  filter(Activity4 %in% c("Work", "NonWork", "Driving")) %>%
  droplevels()
# recode the activities in the sedentary data
df_sedentMultimodal$Activity4 = factor(df_sedentMultimodal$Activity4, levels = c("Work", "NonWork", "Driving"))

df_sedentMultimodal <- df_sedentMultimodal %>%
  drop_na(NHR_Stress) %>%
  droplevels() %>%
  ungroup()

str(df_sedentMultimodal)
```


# Age and BMI Descriptive Statistics
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(psych)

df %>% 
  group_by(Participant) %>%
  drop_na(c(Age, BMI)) %>%
  dplyr::select(Age,BMI) %>%
  distinct() %>%
  describe()
detach("package:psych", unload=TRUE)

```



# Physical Acitvity (PA) Per Participant & Day
```{r PhysicalActivityComputations, echo=FALSE}
library(psych)

# Calculate PA_Percent 
PA_Percent_Summary <- df %>% 
  group_by(Participant, Day) %>%
  summarise(nT = sum(Activity4 == "Work"| Activity4 == "NonWork"| Activity4 == "Driving"| Activity4 == "Running" | Activity4 == "Walking" | Activity4 == "Biking", na.rm = TRUE), PA_Percent = sum(Activity4 == "Walking" | Activity4 == "Running" | Activity4 == "Biking", na.rm = TRUE) *100 / nT
  )  %>%
  ungroup() %>%
  mutate(total_n = sum(nT)) # add df len with

PA_Percent_Summary = PA_Percent_Summary %>% # remove the total_n column
  dplyr::select(-total_n) 

# Calculate PA_Intensity
PA_Intensity_Summary = df %>%
  group_by(Participant, Day) %>%
  filter(Activity4 %in% c("Walking", "Running", "Biking")) %>%
  summarise(
    PA_Intensity = round(mean(Cadence, na.rm=TRUE),1) # mean Cadence per day per subject
  ) 

All_Summary = merge(PA_Percent_Summary, PA_Intensity_Summary, by = c("Participant", "Day"), all.x = T) 

All_Summary 

describe(All_Summary )

detach("package:psych", unload=TRUE)
```

# Frequencies of Sedentary Activities Per Day and Participant
```{r StressThresholdComputations}
# table of sedentary activities per day and participant
df_sedentMultimodal$NHR_Stress <- as.factor(df_sedentMultimodal$NHR_Stress)
table(df_sedentMultimodal$Participant, df_sedentMultimodal$Activity4, df_sedentMultimodal$Day)
```

# Distrubution of NHR in Sedentary Activities
```{r HR_Normalized_pdf}
df_sedentMultimodal %>%
  ggplot(aes(x = HR_Normalized, fill = Activity4)) +
  geom_density(alpha = 0.5) +
  my_theme1 +
  theme(legend.position = "top") +
  guides(fill=guide_legend("Activity")) +
  labs(x = TeX(r'(\textit{NHR} \[BPM\])'),
       y = "PDF") 
```

# Viz of Stress Distribution and QQ Plots for T025
```{r Stress_Threshold_Viz_t025, echo=FALSE, fig.height=11, fig.width=11}
# Create a complete grid of Participant and Day combinations
complete_grid <- expand_grid(
  Participant = sprintf("T%03d", 1:25), 
  Day = c("CD", "WD", "ND")
)

complete_grid$Day = factor(complete_grid$Day, levels = c("CD", "WD", "ND"))

# Ensure all combinations are present in the data
df_sedentMultimodalForm <- complete_grid %>%
  left_join(df_sedentMultimodal, by = c("Participant", "Day"))

# T025
 plot_stress_distr <- df_sedentMultimodalForm %>% 
 filter(Participant %in% sprintf("T%03d", 25) ) %>%
 ggplot(aes(x = HR_Normalized, fill = NHR_Stress)) +
 scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
 geom_histogram( position = "dodge", binwidth = 1) +
 facet_wrap(~Participant+Day, ncol = 3) +
 my_theme1 +
 scale_x_continuous(breaks = seq(-10, 40, by = 10)) +
 theme(legend.position = "none") +
 labs(x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
 geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

# Create qq plots for T025 of Day
plot_stress_qq <- df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 25) ) %>%
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3) +
  theme(legend.position = "none")

plot_stress_label <- cowplot::plot_grid(plot_stress_distr, plot_stress_qq, label_size = 8,
                   labels = c("a1","a2"), ncol = 1, nrow = 2)

plot_stress_label

plot_file = paste0(plot_dir, "NHR-Stress-Label-Plots-T025.pdf")
ggsave(plot_file, plot_stress_label, width = 4.0, height = 4.0, dpi = 300)

library(psych)

df_sedentMultimodalForm %>%
  ungroup() %>%
  filter(Participant %in% sprintf("T%03d", 25) ) %>%
  group_by(Day) %>%
  dplyr::select(Participant,Day, HR_Normalized, PA_Percent, PA_Intensity) %>%
  distinct() %>%
  ungroup() %>%
  psych::describe()

detach("package:psych", unload=TRUE)
```

# Viz of Stress Distribution per Participant and Day
```{r Stress_Threshold_Viz_1_6, echo=FALSE, fig.height=11, fig.width=11}
# T001, T002, T003, T004, T005, T006
df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(x = HR_Normalized, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1 +
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, blue line = 0+2SD, black line = Median",
       x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 1:6) ) %>%
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r Stress_Threshold_Viz_7_12, echo=FALSE, fig.height=11, fig.width=11}
# T007, T008, T009, T010, T011, T012
df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, blue line = 0+2SD, black line = Median",
       x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 7:12) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r Stress_Threshold_Viz-14-18, echo=FALSE, fig.height=11, fig.width=11}
# T014, T015, T016, T017, T018
df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, blue line = 0+2SD, black line = Median",
       x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 14:18) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

```{r Stress_Threshold_Viz_19_25, echo=FALSE, fig.height=11, fig.width=11}
# T019, T020, T021, T022, T023, T024, T025
df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(x = HR_Normalized, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 0.9))+
  geom_histogram( position = "dodge", binwidth = 1) +
  facet_wrap(~Participant+Day, ncol = 3) +
  my_theme1+
  theme(legend.position = "right") +
  labs(title = "Normalized HR in Sedentary Activities, blue line = 0+2SD, black line = Median",
       x = TeX(r'(\textit{NHR} \[BPM\])'), y = "Frequency") +
  #geom_vline(aes(xintercept = NHR_Median), color = "black", linetype = 1) +
  geom_vline(aes(xintercept = NHR_0_2SD), color = "blue", linetype = 3, linewidth = 1) 

df_sedentMultimodalForm %>% 
  filter(Participant %in% sprintf("T%03d", 19:25) ) %>% 
  ggplot(aes(sample = HR_Normalized)) +
  geom_qq() +
  stat_qq_line(color="red") +
  my_theme1 +
  labs(title = "QQ Plot of Normalized HR in Sedentary Activities",
       x = "Theoretical Quantiles", y = "Sample Quantiles") +
  facet_wrap(~Participant+Day, ncol = 3, scales = "free_y") +
  theme(legend.position = "none")
```

# PA_Percent Plot
```{r PA_Percent_Plot, echo=FALSE}
library(psych)

df_sedentMultimodal %>%
  group_by(Participant, Day) %>% drop_na(HR_Normalized) %>%
  mutate(n_sedent = sum(Activity4 == "Work"| Activity4 == "NonWork"| Activity4 == "Driving", na.rm = TRUE),
         n_stress = sum(NHR_Stress == "S", na.rm = TRUE),
         ) %>%
  dplyr::select(Participant, Day, n_sedent, n_stress, NHR_S, PA_Percent) %>%
  distinct()

plot_PA_Percent = df_sedentMultimodal %>%
  group_by(Participant, Day) %>%
  dplyr::select(Participant, Day, Date, PA_Percent) %>%
  distinct() %>%
ggplot(aes(x = Day, y = PA_Percent/100, fill = Day)) +
geom_boxplot() +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "", y = TeX(r'($\textit{PA}_{pc}$)'), title = "") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -2.00, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

plot_PA_Percent

detach("package:psych", unload=TRUE)
```

# Stress Percent Plots
```{r Stress_Barplots_1_6, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 1:6)

mycolors_stress = c(NHR_NS = "green", NHR_S ="red")

df_sedentMultimodal %>%
  filter(Participant %in% tmp_P_list) %>%
  dplyr::select(Participant, Day, NHR_S, NHR_NS,PA_Percent) %>%
  mutate(Participant = factor(Participant, levels = tmp_P_list)) %>%
  distinct() %>%
  pivot_longer(
    cols = c(NHR_S, NHR_NS), 
    names_to = "NHR_Stress", 
    values_to = "Percent"
  ) %>%
  ggplot(aes(x = NHR_Stress, y= Percent, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent, linetype = "PA_Percent"), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  scale_linetype_manual(values = c("PA_Percent" = 2)) +
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%", title = "--- PA_Percent")
```

```{r Stress_Barplots_7_12, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 7:12)

df_sedentMultimodal %>%
  filter(Participant %in% tmp_P_list) %>%
  dplyr::select(Participant, Day, NHR_S, NHR_NS,PA_Percent) %>%
  mutate(Participant = factor(Participant, levels = tmp_P_list)) %>%
  distinct() %>%
  pivot_longer(
    cols = c(NHR_S, NHR_NS), 
    names_to = "NHR_Stress", 
    values_to = "Percent"
  ) %>%
  ggplot(aes(x = NHR_Stress, y= Percent, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r Stress_Barplots_14_18, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 14:18)

df_sedentMultimodal %>%
  filter(Participant %in% tmp_P_list) %>%
  dplyr::select(Participant, Day, NHR_S, NHR_NS,PA_Percent) %>%
  mutate(Participant = factor(Participant, levels = tmp_P_list)) %>%
  distinct() %>%
  pivot_longer(
    cols = c(NHR_S, NHR_NS), 
    names_to = "NHR_Stress", 
    values_to = "Percent"
  ) %>%
  ggplot(aes(x = NHR_Stress, y= Percent, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```


```{r Stress_Barplots_19_25, fig.height=11, fig.width=9}
tmp_P_list = sprintf("T%03d", 19:25)

df_sedentMultimodal %>%
  filter(Participant %in% tmp_P_list) %>%
  dplyr::select(Participant, Day, NHR_S, NHR_NS,PA_Percent) %>%
  mutate(Participant = factor(Participant, levels = tmp_P_list)) %>%
  distinct() %>%
  pivot_longer(
    cols = c(NHR_S, NHR_NS), 
    names_to = "NHR_Stress", 
    values_to = "Percent"
  ) %>%
  ggplot(aes(x = NHR_Stress, y= Percent, fill = NHR_Stress)) +
  scale_fill_manual(values = alpha(mycolors_stress, 1)) +
  geom_bar(stat = "identity") +
  geom_hline(aes(yintercept = PA_Percent), color = "black", linetype = 2) +
  facet_wrap(~Participant + Day, ncol = 3, drop = FALSE) + # Force null facets
  my_theme1 +
  theme(legend.position = "top") +
  labs(x = "", y = "%")
```

\newpage

# Big 5 Box Plots
```{r echo=FALSE, fig.height=5, fig.width=7, message=FALSE, warning=FALSE}

Profession = df_sedentMultimodal %>% 
  group_by(Profession) %>%
  dplyr::select(Participant, Profession) %>% drop_na() %>%
  distinct() 
  

big5_df = df_sedentMultimodal %>%
  dplyr::select(Participant, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness) %>%
  drop_na() %>%
  distinct() %>%
  mutate(
    Participant = as.character(Participant),
    Agreeableness = as.numeric(Agreeableness),
    Conscientiousness = as.numeric(Conscientiousness),
    Extraversion = as.numeric(Extraversion),
    Neuroticism = as.numeric(Neuroticism),
    Openness = as.numeric(Openness)
  ) %>%
  dplyr::select(Participant, Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness) 

xo = c("~bolditalic(B5[A])", "~bolditalic(B5[C])", "~bolditalic(B5[E])", "~bolditalic(B5[N])", "~bolditalic(B5[O])")
library(psych)
describe(big5_df)
detach("package:psych", unload=TRUE)

All_big5_plots = big5_df %>%
pivot_longer(cols = -c("Participant"), names_to = "Big5", values_to = "Score") %>%
ggplot(aes(x = Big5, y = Score)) +
geom_boxplot(fill = "white") +
scale_x_discrete(labels = parse(text=xo))+
scale_y_continuous(breaks = seq(2, 10, by = 2)) +
my_theme1 +
labs(x = "", y = "Big-Five Scores")+
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -0.1, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

print(All_big5_plots)


```

# Cadence PDF
```{r Cadence_Plot}
library(psych)

plot_cadence_pdf <- df %>% filter(!is.na(Cadence)) %>%
  filter(!is.na(PA_Activity)) %>%
  ggplot(aes(x = Cadence, fill = PA_Activity)) +
  geom_density(alpha = 0.6) +
  theme(legend.position = "top") +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold")) +
  theme(legend.title = element_text(size = 5), 
               legend.text = element_text(size = 5)) +
  theme(legend.key.size = unit(0.4, "cm")) +
   labs(x = TeX(r'($\textit{CDN} \ \[CPM\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

print(plot_cadence_pdf)

df %>% filter(!is.na(Cadence)) %>%
 filter(PA_Activity == "Sedentary") %>%   filter(!is.na(PA_Activity)) %>% describe()

df %>% filter(!is.na(Cadence)) %>%
 filter(PA_Activity == "PA") %>%   filter(!is.na(PA_Activity)) %>% describe()

detach("package:psych", unload=TRUE)
```

\newpage

# Profession and Gender Plot
```{r Profession_Plot, echo=FALSE, fig.height=5, fig.width=5}
prof.plot <- df_sedentMultimodal %>%
  ungroup() %>%
  dplyr::select(Participant, Profession) %>%   drop_na() %>%
  group_by(Profession) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Profession, y = prop, fill = Profession)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Profession Distribution") +
  my_theme1 

prof.plot
# gender.plot

gender.plot <- df_sedentMultimodal %>%
  ungroup() %>%
  dplyr::select(Participant, Gender) %>%   drop_na() %>%
  group_by(Gender) %>%
  distinct() %>%
  count() %>%
  ungroup() %>%
  mutate(
    sum_n = sum(n),
    prop = n / sum_n 
  ) %>%
  ggplot(aes(x = Gender, y = prop, fill = Gender)) +
  geom_bar(stat = "identity",  fill = c("coral1", "darkturquoise")) +
    scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label = n),
            vjust = 1.6,
            color = "black",
            size = 5) +
  labs(x = "", y = "", title = " Gender Distribution") +
  my_theme1 

gender.plot
```

# NASA Mental Demand Plot
```{r NASA_MD_Plot, message=FALSE, warning=FALSE}
library(psych)

NASA_Data_MD = df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date, starts_with("N_MD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()

describe.by(NASA_Data_MD, NASA_Data_MD$Day)
 
Nasa_p1MD = NASA_Data_MD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_MD, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{MD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -2.00, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1MD

detach("package:psych", unload=TRUE)
```

# NASA Physical Demand Plot
```{r NASA_PD_Plot, message=FALSE, warning=FALSE}
library(psych)

NASA_Data_PD =
  df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_PD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()


describe.by(NASA_Data_PD, NASA_Data_PD$Day)

Nasa_p1PD = NASA_Data_PD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_PD, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{PD}}$)')) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = -3.50, hjust = 0.0, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1PD

detach("package:psych", unload=TRUE)
```

# NASA Temporal Demand Plot
```{r NASA_TD_Plot, message=FALSE, warning=FALSE}
NASA_Data_TD = df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_TD"), Profession) %>%
  #dplyr::select(starts_with("N_TD"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()

Nasa_p1TD = NASA_Data_TD %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_TD, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{TD}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{TD}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 0.5, hjust = 0.0, angle = 0,
    #parse = T, size = 5, vjust = -0.75, hjust = -0.75, angle = 90,
    position = position_dodge(width = 0.75)
  )

Nasa_p1TD
```

# NASA Performance Plot
```{r NASA_P_Plot, message=FALSE, warning=FALSE}
library(psych)

NASA_Data_P = df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_P"), Profession) %>%
  #dplyr::select(starts_with("N_P"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()

describe.by(NASA_Data_P, NASA_Data_P$Day)

Nasa_p1P = NASA_Data_P %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_P, fill = Day)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  labs(x = "", y = TeX(r'($\textit{NASA_{P}}$)')) +# geom_point() + ylim(c(1, 20)) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"),
        legend.position = "none") +
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 2, vjust = 1.95, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1P

detach("package:psych", unload=TRUE)
```

# NASA Effort Plot
```{r NASA_E_Plot, message=FALSE, warning=FALSE}
NASA_Data_E = df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_E"), Profession) %>%
  #dplyr::select(starts_with("N_E"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()

Nasa_p1E = NASA_Data_E %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_E, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  scale_y_continuous(breaks = seq(0, 20, by = 5)) +
  
  labs(x = "", y = TeX(r'($\textit{NASA_{E}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{E}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 1.5, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1E 
```

# NASA Frustration Plot
```{r NASA_F_Plot, message=FALSE, warning=FALSE}
NASA_Data_F = df_sedentMultimodal %>% 
  dplyr::select(Participant, Day, Date,starts_with("N_F"), Profession) %>%
  #dplyr::select(starts_with("N_F"), Profession) %>%
  mutate_if(is.character,as.numeric) %>%
  drop_na() %>%
  distinct()

Nasa_p1F = NASA_Data_F %>%
  group_by(Day) %>%
  mutate(
    n = n()
  ) %>%
  ggplot(aes(x =  Day, y = N_F, fill = Day)) +
  geom_boxplot() +
  
  my_theme1 +
  scale_y_continuous(breaks = seq(0, 150, by = 10)) +
  
  labs(x = "", y = TeX(r'($\textit{NASA_{F}}$)')) +# geom_point() + ylim(c(1, 20)) +
  geom_text(label =  TeX(r'($\textit{NASA_{F}}$)'), x = 4, y=18, color = "black", size = 5) +

  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 4, vjust = 1.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

Nasa_p1F
```

# Sleep Duration PDF
```{r SLEEP, echo=FALSE}
library(psych)

Sleep_df <- df_sedentMultimodal %>%
  dplyr::select(Participant, Day, Sleep_Time) %>%
  distinct()

Sleep_df

describe(Sleep_df)

Sleep_Plot = Sleep_df  %>%
  filter(!is.na(Sleep_Time)) %>%
  #distinct() %>%
  ggplot(aes(x=Sleep_Time)) +
  geom_density(fill = "gray") +
  labs(x = TeX(r'($\textit{SLEEP} \ \[hr\]$)'),
       y = "PDF"
       ) +
  theme(axis.text=element_text(size=6),
        axis.title=element_text(size=8,face="bold"))

Sleep_Plot

detach("package:psych", unload=TRUE)
```

# mCadence Plot
```{r echo=FALSE}
library(psych)

describe(df_sedentMultimodal)

mCadence_p1 = df_sedentMultimodal %>%
  #filter(!is.na(PA_Intensity)) %>%
  #distinct() %>%
  ggplot(aes(x=Cadence)) +
  geom_density(fill = "black") +
  my_theme1 +
  theme(legend.position = "top") +
   labs(x = TeX(r'($\textit{mCDN} \ \[CPM\]$)'),
       y = "PDF",
       fill = ""
       ) +theme(legend.position = c(0.8, 0.8), #"top",
                  legend.box.margin = margin(0, -1, 0, 0))

mCadence_p1

detach("package:psych", unload=TRUE)
```

# mCadence Box Plot
```{r mCadence_Box_Plot, echo=FALSE}
candece_p1 = df_sedentMultimodal %>%
  dplyr::select(Participant, Day, Cadence) %>%
  #distinct() %>%
  group_by(Participant, Day) %>%
  ggplot(aes(x= Day, y = Cadence, fill = Day)) +
 geom_boxplot()+
  my_theme1 +
  labs(x = "", y = TeX(r'($\textit{mCDN} \ \[CPM\]$)')) + 
  stat_summary(
    fun.data = n_fun, geom = "text", fun.y = median,
    parse = T, size = 3, vjust = -0.75, hjust = 0.5, angle = 0,
    position = position_dodge(width = 0.75)
  )

candece_p1
```

# EDA Plots
```{r EDA_Plots, echo=FALSE, fig.height=5, fig.width=4}
plot_eda_top <- cowplot::plot_grid(plot_cadence_pdf, Sleep_Plot, Nasa_p1MD, Nasa_p1P, label_size = 8,
                   labels = c("a1","a2","a3", "a4"), ncol = 2, nrow = 2)


plot_eda <- cowplot::plot_grid(plot_eda_top, All_big5_plots, label_size = 10,
                   labels = c("", "a5"), ncol = 1, nrow = 2)
                   
plot_eda

plot_file = paste0(plot_dir, "NHR-Stress-EDA-Plots.pdf")
ggsave(plot_file, plot_eda, width = 4.0, height = 5.0, dpi = 300)
```

# Correlation Plot
```{r Collinearity_Plot, include=FALSE}
df_sedentMultimodal$Activity4 <-factor(df_sedentMultimodal$Activity4, levels = c("Work","NonWork","Driving"))
df_sedentMultimodal$Day <- relevel(df_sedentMultimodal$Day, ref = "CD")
df_sedentMultimodal$Period <- factor(df_sedentMultimodal$Period, levels =c("Morning","Afternoon"))

# df_sedentMultimodal = merge(df_sedentMultimodal, big5_df, by.x = c("Participant", "Profession"), by.y  = c("ID", "Profession"), x.all = TRUE)
```

```{r fig.height=11, fig.width=11, message=FALSE, warning=FALSE}
library(ggtext)
library(psych)

reduced_data <- subset(df_sedentMultimodal, 
                       select = c(Day, Period, Activity4, Cadence,PA_Percent, PA_Intensity, 
                                  Sleep_Time, Profession,
                                  N_MD, N_PD, N_TD, N_P, N_E, N_F,
                                  Agreeableness, Conscientiousness, Extraversion, Neuroticism, Openness))


reduced_data = rename(reduced_data, c(
"DAY" = "Day", 
"PRD" = "Period",
"ACT" = "Activity4", 
"PA_pc" = "PA_Percent", 
"PA_int" = "PA_Intensity", 
"SLEEP" = "Sleep_Time", 
"OCC" = "Profession",
"NASA_MD" = "N_MD", 
"NASA_PD" = "N_PD", 
"NASA_TD" = "N_TD", 
"NASA_P" = "N_P",
"NASA_E" = "N_E", 
"NASA_F" = "N_F", 
"B5_A" = "Agreeableness", 
"B5_C" = "Conscientiousness",
"B5_E" = "Extraversion", 
"B5_N" = "Neuroticism",
"B5_O" = "Openness"))

correlation_plot2 <- model.matrix(~., data=reduced_data)
correlation_plot <- cor((correlation_plot2), use="everything") 
colnames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [ND]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")
rownames(correlation_plot) <- c("Intercept", "*DAY* &nbsp; [WD]", "*DAY* &nbsp; [ND]", "*PRD* &nbsp; [AFN]", "*ACT* &nbsp; [NonWork]", "*ACT* &nbsp; [Driving]", "*CDN*", "*PA<sub>pc</sub>*", "*PA<sub>int</sub>*", "*SLEEP*", "*OCC* &nbsp; [SP]", "*NASA<sub>MD</sub>*", "*NASA<sub>PD</sub>*", "*NASA<sub>TD</sub>*", "*NASA<sub>P</sub>*", "*NASA<sub>E</sub>*", "*NASA<sub>F</sub>*", "*B5<sub>A</sub>*", "*B5<sub>C</sub>*", "*B5<sub>E</sub>*", "*B5<sub>N</sub>*", "*B5<sub>O</sub>*")

corr.plot <- (ggcorrplot(correlation_plot, show.diag=FALSE, type="lower", lab=TRUE) + theme(axis.text = element_markdown()))

corr.plot

plot_file = paste0(plot_dir, "NHR-Stress-Correlation-Plot.pdf")
ggsave(plot_file, corr.plot, width = 11.0, height = 11.0, dpi = 300)

library(data.table) 
  
set.seed(1) 
  
# counting frequencies of factor 
# levels 
setDT(reduced_data)[, .N, keyby=ACT] 

detach("package:psych", unload=TRUE)
```

\newpage

# Full Logistic Regression Mixed Effects Model (Stress from NHR)
```{r Full_LRM, echo=FALSE, warning=FALSE}
# Fit the model
## PA_Intensity has 23 subjects, T008 all days have NA for PA_Intensity

library(sjPlot)
library(sjmisc)

stress_logit_model = glmer(NHR_Stress ~  Cadence + Day*Period + Activity4 + Day*PA_Percent*PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Conscientiousness + Extraversion + Neuroticism + Openness + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))

summary(stress_logit_model)
summ(stress_logit_model, digits=4)

#show random effects
ranef(stress_logit_model)

m.plot.main1 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Cadence[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = TeX(r'($\textit{mCDN} \ \[CPM\]$)'), 
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main2 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = "",
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main3 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Activity4[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.title.x = element_blank(), 
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main4 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_MD[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{NASA_{MD}}$)'), 
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main5 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_PD[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{NASA_{PD}}$)'),
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.main6 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("N_P[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = TeX(r'($\textit{NASA_{P}}$)'),
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main7 <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Extraversion[all]"),
                   colors = "black") +
                   theme_bw() +
                   theme(axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   labs(x = TeX(r'($\textit{B5_{E}}$)'),
                        y = TeX(r'($\textit{P(S)}$)'))

m.plot.2way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "Period[all]")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.3way <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]", "PA_Percent[4.43, 17.68]", "PA_Intensity")) +
                   theme_bw() +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                    labs(x = "",
                         y = TeX(r'($\textit{P(S)}$)'))

m.plot.main1

m.plot.main2

m.plot.main3

m.plot.main4

m.plot.main5

m.plot.main6

m.plot.main7

m.plot.2way

m.plot.3way
```

# Remove Conscientiousness from the Model
```{r Optimized_Model1, echo=FALSE, warning=FALSE}
# Fit the model
stress_logit_model1 = glmer(NHR_Stress ~ Cadence + Day*Period + Activity4 + Day*PA_Percent*PA_Intensity + Sleep_Time + Profession + N_MD + N_PD + N_P + Agreeableness + Extraversion + Neuroticism + Openness + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))

summary(stress_logit_model1)
summ(stress_logit_model1, digits=4)
```

# Optimal and Scaled Model
```{r Optimal_Scaled_Model}
df_sedentMultimodal$s_Cadence <- scale(df_sedentMultimodal$Cadence)
df_sedentMultimodal$s_PA_Percent <- scale(df_sedentMultimodal$PA_Percent)
df_sedentMultimodal$s_PA_Intensity <- scale(df_sedentMultimodal$PA_Intensity)
df_sedentMultimodal$s_Sleep_Time <- scale(df_sedentMultimodal$Sleep_Time)
df_sedentMultimodal$s_N_MD <- scale(df_sedentMultimodal$N_MD)
df_sedentMultimodal$s_N_PD <- scale(df_sedentMultimodal$N_PD)
df_sedentMultimodal$s_N_P <- scale(df_sedentMultimodal$N_P)
df_sedentMultimodal$s_Agreeableness <- scale(df_sedentMultimodal$Agreeableness)
df_sedentMultimodal$s_Extraversion <- scale(df_sedentMultimodal$Extraversion)
df_sedentMultimodal$s_Neuroticism <- scale(df_sedentMultimodal$Neuroticism)
df_sedentMultimodal$s_Openness <- scale(df_sedentMultimodal$Openness)


stress_logit_model_s = glmer(NHR_Stress ~  s_Cadence + Day*Period + Activity4 + Day*s_PA_Percent*s_PA_Intensity + s_Sleep_Time + Profession + s_N_MD + s_N_PD + s_N_P + s_Agreeableness + s_Extraversion + s_Neuroticism + s_Openness + (1 | Participant), data = df_sedentMultimodal, family = binomial(link = "logit"))

summary(stress_logit_model_s)
summ(stress_logit_model_s, confint = TRUE, digits=4)
```

# Visualization of NHR Stress Model 
```{r echo=FALSE, fig.height=4.5, fig.width=7}
library(ggeffects)

m.plot.main_cdn <-  ggpredict(stress_logit_model_s, "s_Cadence[all]") %>%
  ggplot(aes(x, predicted)) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  geom_line(colour = "red", size = 2) +
  geom_vline(
    xintercept = mean(df_sedentMultimodal$s_Cadence, na.rm = TRUE),
    linetype = "dashed",
    color = "gray",
    size = 1
  ) +   my_theme3 + 
  coord_cartesian(ylim = c(0.1, 1)) + 
  scale_y_continuous(labels = scales::percent) +
  #remove y axis labels
  labs(x = TeX(r'($\textit{mCDN} \ \[CPM\]$)'), y = TeX(r'($\textit{P(S)}$)'))

m.plot.main_cdn 

m.plot.main_day <- sjPlot::plot_model(stress_logit_model,
                   type = "pred",
                   terms = c("Day[all]"),
                   colors = "black",
                   title = "") +
                   theme_bw() +
                   theme(
                         axis.text = element_text(size = 10), 
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank()) +
                   scale_x_discrete(labels = c("CD", "WD", "ND")) +
                   scale_y_continuous(labels = scales::percent)  +
                   labs(x = "", y = TeX(r'($\textit{P(S)}$)'))

m.plot.main_day

m.plot.main_act <- ggpredict(stress_logit_model_s,
  terms = c("Activity4")) %>%
  mutate(group = as.factor(c("1", "2", "3"))) %>%
  drop_na() %>%
  gather(key = "key", value = "value", conf.low, conf.high) %>%
  ggplot() +
  geom_line(aes(x = x, y = value, color = group), size = 2) +
  geom_point(aes(x = x, y = predicted, color = group, size = 2)) +
  scale_color_manual(values = c("gray", "red", "black")) +
  coord_cartesian(ylim = c(0.1, 1)) +  
  my_theme3 + 
  scale_x_discrete(labels = c("WRK", TeX(r'($\neg$WRK)'), "DRV")) +
  scale_y_continuous(labels = scales::percent)  +
  labs(x = "", y = "") + theme(axis.text.y = element_blank()) 

m.plot.main_act

m.plot.main_nmd <- ggpredict(stress_logit_model_s, "s_N_MD[all]") %>%
    ggplot(aes(x, predicted)) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
    geom_line(colour = "red", size = 2) +
    geom_vline(
     xintercept = mean(df_sedentMultimodal$Ps_N_MD),
     linetype = "dashed",
     color = "gray",
     size = 1
   ) +  my_theme3 + coord_cartesian(ylim = c(0.1, 1)) +  
   scale_y_continuous(labels = scales::percent) +
   labs(x = TeX(r'($\textit{NASA_{MD}}$)'), y = "") + theme(axis.text.y = element_blank()) 

m.plot.main_nmd

m.plot.2way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   colors = c("coral", "blue"),
                   axis.title = TeX(r'($\textit{P(S)}$)'),
                   terms = c("Day[all]", "Period[all]")) +
                   set_theme (
                     base = my_theme3,
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                     axis.text = element_text(size = 10),
                     panel.grid.major = element_blank(), 
                     panel.grid.minor = element_blank()) +
                    labs(x = "", y = "", title = "")   +
  coord_cartesian(ylim = c(0.1, 1.0)) + 
  scale_y_continuous(labels = scales::percent) +
  labs(x ="", y = TeX(r'($\textit{P(S)}$)'))

m.plot.2way

m.plot.3way <- sjPlot::plot_model(stress_logit_model_s,
                   type = "pred",
                   colors = c("coral", "blue"),
                   axis.title = TeX(r'($\textit{P(S)}$)'),
                   legend.title="Scaled PA Extent",
                   terms = c("Day[all]", "s_PA_Percent[-1, 1]", "s_PA_Intensity[-1, 1]")) +
                   set_theme (
                     base = my_theme3,
                     legend.pos = "bottom") +
                   theme(axis.title.x = element_blank(),
                         axis.text = element_text(size = 10),
                         panel.grid.major = element_blank(), 
                         panel.grid.minor = element_blank())+
                    labs( title = "") +
  coord_cartesian(ylim = c(0.1, 1.0)) + 
  scale_y_continuous(labels = scales::percent)  +
  labs(x ="", y = TeX(r'($\textit{P(S)}$)'))

m.plot.3way$data$facet <- factor(m.plot.3way$data$facet)
#levels(m.plot.3way$data$facet)  <- c("PA Intensity = -1", "PA Intensity = 1")

m.plot.3way
```

&nbsp;

# Composite Model Figure
```{r Composite_Model_Figure, echo=FALSE, fig.height=9, fig.width=7, message=FALSE, warning=FALSE}

p_a <- cowplot::plot_grid(
  m.plot.2way,
  nrow = 1,
  scale = c(.97),
  labels = c("a1"),
  label_size = 13
) 

p_e <- cowplot::plot_grid(
  m.plot.3way,
  nrow = 1,
  scale = c(.97),
  labels = c("a2"),
  label_size = 13
) 

p_bcd <- cowplot::plot_grid(
  m.plot.main_cdn, m.plot.main_act, m.plot.main_nmd,
  nrow = 1,
  scale = c(0.97, .97, .97),
  labels = c("a3", "a4", "a5"),
  label_size = 13
)

final.w.legend <- cowplot::plot_grid(p_a, p_e, p_bcd, mylegend, 
  nrow = 4,   
  scale = c(0.97, .97, .97,.1),
  rel_heights = c(3.0, 3.0, 3.0, 0.5)
)

final.w.legend

# save the plot
plot_file = paste0(plot_dir, "NHR-Stress-Model-Plots.pdf")
ggsave(plot_file, final.w.legend, width = 5.5, height = 8, dpi = 300)

levels(df_sedentMultimodal$Participant)
```

